"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[649],{1575:function(e,t,i){i.d(t,{M:function(){return K}});var s=i(3471),r=i(7320),n=i(9502),a=i(6048),h=i(8958),o=i(5842),d=i(9216),l=i(6404),p=i(3272),u=i(3053),g=i(4199),c=i(2976),y=i(5292),m=i(6377),f=i(8909),S=i(4669),I=i(9956),P=i(1381),w=i(6181),_=i(8719),v=i(1208),x=i(4107),C=i(8432),B=i(6789),b=i(6391),A=i(3349),T=i(1427),F=i(1488),M=i(8642),k=i(7311),E=i(7573),O=i(158),R=i(3755),N=i(7810),z=i(9679),U=i(2902),L=i(4930),D=Object.defineProperty,X=Object.getOwnPropertyDescriptor,G=(e,t,i,s)=>{for(var r,n=s>1?void 0:s?X(t,i):t,a=e.length-1;a>=0;a--)(r=e[a])&&(n=(s?r(t,i,n):r(n))||n);return s&&n&&D(t,i,n),n};class K extends h.EventEmitter{constructor({store:e,user:t,shapes:i,tools:s,getContainer:r}){super(),this.store=e,this.user=new F.K(t??(0,l.L)()),this.getContainer=r??(()=>document.body),this.textMeasure=new A.R(this),this.root=new L.m(this);let h=(0,p.me)(i),o=new Set(Object.keys(e.schema.types.shape.migrations.subTypeMigrations));for(let e of h){if(!o.has(e.type))throw Error(`Editor and store have different shapes: "${e.type}" was passed into the editor but not the schema`);o.delete(e.type)}if(o.size>0)throw Error(`Editor and store have different shapes: "${[...o][0]}" is present in the store schema but not provided to the editor`);let d={},u=new Map;for(let{util:e,props:t}of h){let i=(0,n.DR)(t??{});for(let t of(d[e.type]=new e(this,e.type,i),i.keys()))if(u.has(t.id)){if(u.get(t.id)!==t)throw Error(`Multiple style props with id "${t.id}" in use. Style prop IDs must be unique.`)}else u.set(t.id,t)}for(let{tool:e}of(this.shapeUtils=d,h))if(e){if((0,a.nr)(this.root.children,e.id))throw Error(`Can't override tool with id "${e.id}"`);this.root.children[e.id]=new e(this)}for(let e of s){if((0,a.nr)(this.root.children,e.id))throw Error(`Can't override tool with id "${e.id}"`);this.root.children[e.id]=new e(this)}"undefined"!=typeof window&&"navigator"in window?(this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isIos=!!navigator.userAgent.match(/iPad/i)||!!navigator.userAgent.match(/iPhone/i),this.isChromeForIos=/crios.*safari/i.test(navigator.userAgent)):(this.isSafari=!1,this.isIos=!1,this.isChromeForIos=!1),this.store.onBeforeDelete=e=>{"shape"===e.typeName?this._shapeWillBeDeleted(e):"page"===e.typeName&&this._pageWillBeDeleted(e)},this.store.onAfterChange=(e,t)=>{this._updateDepth++,this._updateDepth>1e3&&console.error("[onAfterChange] Maximum update depth exceeded, bailing out."),"shape"===e.typeName&&"shape"===t.typeName?this._shapeDidChange(e,t):"instance_page_state"===e.typeName&&"instance_page_state"===t.typeName&&this._pageStateDidChange(e,t),this._updateDepth--},this.store.onAfterCreate=e=>{if("shape"===e.typeName&&this.isShapeOfType(e,k.Y)&&this._arrowDidUpdate(e),"page"===e.typeName){let t=n.AN.createId(e.id),i=n.iS.createId(e.id);this.store.has(t)||this.store.put([n.AN.create({id:t})]),this.store.has(i)||this.store.put([n.iS.create({id:i,pageId:e.id})])}},this._currentPageShapeIds=(0,w.Q)(this.store,()=>this.currentPageId),this._parentIdsToChildIds=(0,P.n)(this.store),this.disposables.add(this.store.listen(e=>{this.emit("change",e)}));let g=this.getContainer(),c=()=>{this._isFocused.set(!0)},y=()=>{this._isFocused.set(!1)};g.addEventListener("focusin",c),g.addEventListener("focus",c),g.addEventListener("focusout",y),g.addEventListener("blur",y),this.disposables.add(()=>{g.removeEventListener("focusin",c),g.removeEventListener("focus",c),g.removeEventListener("focusout",y),g.removeEventListener("blur",y)}),this.store.ensureStoreIsUsable(),this.setInstancePageState({editingId:null,hoveredId:null,erasingIds:[]},!0),this.root.enter(void 0,"initial"),this.instanceState.followingUserId&&this.stopFollowingUser(),this.updateRenderingBounds(),requestAnimationFrame(()=>{this._tickManager.start()})}store;root;disposables=new Set;_dprManager=new x.O(this);_activeAreaManager=new _.b_(this);_tickManager=new T.r(this);_updateDepth=0;externalContentManager=new C.C(this);snaps=new b.f(this);user;isSafari;isIos;isChromeForIos;getContainer;get _pageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if((0,n.r5)(e.parentId))return this.getTransform(e);let t=this._pageTransformCache.get(e.parentId)??r.yX.Identity();return r.yX.Compose(t,this.getTransform(e))})}get _pageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{let t=this._pageTransformCache.get(e.id);if(!t)return new r.No;let i=r.No.FromPoints(r.yX.applyToPoints(t,this.getShapeUtil(e).outline(e)));return i})}dispose(){this.disposables.forEach(e=>e()),this.disposables.clear()}history=new B.E(this,()=>this._complete(),e=>{this.annotateError(e,{origin:"history.batch",willCrashApp:!0}),this.crash(e)});undo(){return this.history.undo()}get canUndo(){return this.history.numUndos>0}redo(){return this.history.redo(),this}get canRedo(){return this.history.numRedos>0}mark(e,t,i){return this.history.mark(e,t,i)}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}batch(e){return this.history.batch(e),this}shapeUtils;getShapeUtil(e){let t=(0,a.eg)(this.shapeUtils,e.type);return(0,a.hu)(t,`No shape util found for type "${e.type}"`),"prototype"in e&&e.prototype instanceof M.E&&(0,a.hu)(t instanceof e,`Shape util found for type "${e.type}" is not an instance of the provided constructor`),t}_extractSharedStyles(e,t){if(this.isShapeOfType(e,z.Q)){let i=this._parentIdsToChildIds.value[e.id];if(i)for(let e=0,s=i.length;e<s;e++)this._extractSharedStyles(this.getShapeById(i[e][0]),t)}else{let i=this.getShapeUtil(e);for(let[s,r]of i.iterateStyles(e))t.applyValue(s,r)}}_selectionSharedStyles=(0,d.Fl)("_selectionSharedStyles",()=>{let{selectedShapes:e}=this,t=new c.o;for(let i of e)this._extractSharedStyles(i,t);return t});get _stylesForNextShape(){return this.instanceState.stylesForNextShape}getStyleForNextShape(e){let t=this._stylesForNextShape[e.id];return void 0===t?e.defaultValue:t}get sharedStyles(){if(this.isIn("select")&&this.selectedIds.length>0)return this._selectionSharedStyles.value;let e=this.root.current.value,t=new c.o;if(e.shapeType)for(let i of this.getShapeUtil(e.shapeType).styleProps.keys())t.applyValue(i,this.getStyleForNextShape(i));return t}get sharedOpacity(){if(this.isIn("select")&&this.selectedIds.length>0){let e=[],t=i=>{let s=this.getShapeById(i);if(s){if(this.isShapeOfType(s,z.Q))for(let e of this.getSortedChildIds(s.id))t(e);else e.push(s)}};for(let e of this.selectedIds)t(e);let i=null;for(let t of e)if(null===i)i=t.opacity;else if(i!==t.opacity)return{type:"mixed"};if(null!==i)return{type:"shared",value:i}}return{type:"shared",value:this.instanceState.opacityForNextShape}}get _arrowBindingsIndex(){return(0,I.w)(this)}getArrowsBoundTo(e){return this._arrowBindingsIndex.value[e]||d.LZ}_reparentArrow(e){let t,i,r;let n=this.getShapeById(e);if(!n)return;let{start:a,end:h}=n.props,o="binding"===a.type?this.getShapeById(a.boundShapeId):void 0,d="binding"===h.type?this.getShapeById(h.boundShapeId):void 0,l=this.getAncestorPageId(n);if(!l)return;if(o&&d)t=this.findCommonAncestor([o,d])??l;else{if(!o&&!d)return;t=l}t&&t!==n.parentId&&this.reparentShapesById([e],t);let p=this.getShapeById(e);if(!p)throw Error("no reparented arrow");let u=this.getShapeNearestSibling(p,o),g=this.getShapeNearestSibling(p,d);if(u&&g)i=u.index>g.index?u:g;else if(u&&!g)i=u;else{if(!g||u)return;i=g}let c=this.getSortedChildIds(i.parentId).map(e=>this.getShapeById(e)).filter(e=>e.index>i.index);if(c.length){let e=c.find(e=>"arrow"!==e.type);if(p.index>i.index&&(!e||p.index<e.index))return;r=(0,s.eI)(i.index,c[0].index)}else r=(0,s._L)(i.index);r!==p.index&&this.updateShapes([{id:e,type:"arrow",index:r}])}_unbindArrowTerminal(e,t){let{x:i,y:s}=(0,O.Qs)(this,e)[t];this.store.put([{...e,props:{...e.props,[t]:{type:"point",x:i,y:s}}}])}get _allPageStates(){return this.store.query.records("instance_page_state")}_shapeWillBeDeleted(e){e.parentId&&(0,n.YT)(e.parentId)&&this._invalidParents.add(e.parentId);let t=this._arrowBindingsIndex.value[e.id];if(t?.length)for(let{arrowId:e,handleId:i}of t){let t=this.getShapeById(e);t&&this._unbindArrowTerminal(t,i)}let i=this._allPageStates.value,s=new Set([e.id]),r=(0,a.oA)(i.map(e=>this._cleanupInstancePageState(e,s)));r.length&&this.store.put(r)}_arrowDidUpdate(e){for(let t of["start","end"]){let i=e.props[t];if("binding"!==i.type)continue;let s=this.getShapeById(i.boundShapeId),r=this.getAncestorPageId(e)===this.getAncestorPageId(s);s&&r||this._unbindArrowTerminal(e,t)}this._reparentArrow(e.id)}_invalidParents=new Set;_complete(){for(let e of this._invalidParents){this._invalidParents.delete(e);let t=this.getShapeById(e);if(!t)continue;let i=this.getShapeUtil(t),s=i.onChildrenChange?.(t);s?.length&&this.updateShapes(s,!0)}this.emit("update")}_cleanupInstancePageState(e,t){let i=null,s=e.selectedIds.filter(e=>!t.has(e));s.length!==e.selectedIds.length&&(i||(i={...e}),i.selectedIds=s);let r=e.erasingIds.filter(e=>!t.has(e));r.length!==e.erasingIds.length&&(i||(i={...e}),i.erasingIds=r),e.hoveredId&&t.has(e.hoveredId)&&(i||(i={...e}),i.hoveredId=null),e.editingId&&t.has(e.editingId)&&(i||(i={...e}),i.editingId=null);let n=e.hintingIds.filter(e=>!t.has(e));return n.length!==e.hintingIds.length&&(i||(i={...e}),i.hintingIds=n),e.focusLayerId&&t.has(e.focusLayerId)&&(i||(i={...e}),i.focusLayerId=null),i}_shapeDidChange(e,t){if(this.isShapeOfType(t,k.Y)&&this._arrowDidUpdate(t),e.parentId!==t.parentId){let e=e=>{let t=this._arrowBindingsIndex.value[e];if(t?.length)for(let e of t)this._reparentArrow(e.arrowId)};e(t.id),this.visitDescendants(t.id,e)}if(e.parentId!==t.parentId&&(0,n.r5)(t.parentId)){let i=new Set([e.id]);for(let s of(this.visitDescendants(e.id,e=>{i.add(e)}),this._allPageStates.value)){if(s.pageId===t.parentId)continue;let e=this._cleanupInstancePageState(s,i);e&&this.store.put([e])}}e.parentId&&(0,n.YT)(e.parentId)&&this._invalidParents.add(e.parentId),t.parentId!==e.parentId&&(0,n.YT)(t.parentId)&&this._invalidParents.add(t.parentId)}_pageStateDidChange(e,t){if(e?.selectedIds!==t?.selectedIds){let e=t.selectedIds.filter(e=>{let i=this.getShapeById(e)?.parentId;for(;(0,n.YT)(i);){if(t.selectedIds.includes(i))return!1;i=this.getShapeById(i)?.parentId}return!0}),i=0===e.length?t?.focusLayerId:this.findCommonAncestor((0,a.oA)(e.map(e=>this.getShapeById(e))),e=>this.isShapeOfType(e,z.Q));(e.length!==t.selectedIds.length||i!=t.focusLayerId)&&this.store.put([{...t,selectedIds:e,focusLayerId:i??null}])}}_pageWillBeDeleted(e){if(this.instanceState.currentPageId!==e.id)return;let t=this.pages.find(t=>t.id!==e.id)?.id;if(!t)return;this.store.put([{...this.instanceState,currentPageId:t}]);let i=n.AN.createId(e.id),s=n.iS.createId(e.id);this.store.remove([i,s])}annotateError(e,{origin:t,willCrashApp:i,tags:s,extras:r}){let n=this.createErrorAnnotations(t,i);(0,a.lw)(e,{tags:{...n.tags,...s},extras:{...n.extras,...r}}),i&&this.store.markAsPossiblyCorrupted()}createErrorAnnotations(e,t){try{return{tags:{origin:e,willCrashApp:t},extras:{activeStateNode:this.root.path.value,selectedShapes:this.selectedShapes,editingShape:this.editingId?this.getShapeById(this.editingId):void 0,inputs:this.inputs}}}catch{return{tags:{origin:e,willCrashApp:t},extras:{}}}}_crashingError=null;get crashingError(){return this._crashingError}crash(e){this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e})}_canMoveCamera=(0,d.cn)("can move camera",!0);get canMoveCamera(){return this._canMoveCamera.value}set canMoveCamera(e){this._canMoveCamera.set(e)}_isFocused=(0,d.cn)("_isFocused",!1);get isFocused(){return this._isFocused.value}get devicePixelRatio(){return this._dprManager.dpr.value}_isCoarsePointer=(0,d.cn)("isCoarsePointer",!1);get isCoarsePointer(){return this._isCoarsePointer.value}set isCoarsePointer(e){this._isCoarsePointer.set(e)}_openMenus=(0,d.cn)("open-menus",[]);get openMenus(){return this._openMenus.value}addOpenMenu(e){let t=new Set(this.openMenus);return t.has(e)||(t.add(e),this._openMenus.set([...t])),this}deleteOpenMenu(e){let t=new Set(this.openMenus);return t.has(e)&&(t.delete(e),this._openMenus.set([...t])),this}get isMenuOpen(){return this.openMenus.length>0}_isChangingStyle=(0,d.cn)("isChangingStyle",!1);_isChangingStyleTimeout=-1;get isChangingStyle(){return this._isChangingStyle.value}set isChangingStyle(e){this._isChangingStyle.set(e),clearTimeout(this._isChangingStyleTimeout),e&&(this._isChangingStyleTimeout=setTimeout(()=>this.isChangingStyle=!1,2e3))}_isPenMode=(0,d.cn)("isPenMode",!1);_touchEventsRemainingBeforeExitingPenMode=0;get isPenMode(){return this._isPenMode.value}setPenMode(e){return e&&(this._touchEventsRemainingBeforeExitingPenMode=3),e!==this.isPenMode&&this._isPenMode.set(e),this}_isReadOnly=(0,d.cn)("isReadOnly",!1);setReadOnly(e){return this._isReadOnly.set(e),e&&this.setSelectedTool("hand"),this}get isReadOnly(){return this._isReadOnly.value}get documentSettings(){return this.store.get(n.G4)}updateDocumentSettings(e){this.store.put([{...this.documentSettings,...e}])}get gridSize(){return this.documentSettings.gridSize}get projectName(){return this.documentSettings.name}setProjectName(e){this.updateDocumentSettings({name:e})}get isSnapMode(){return this.user.isSnapMode}setSnapMode(e){return e!==this.isSnapMode&&this.user.updateUserPreferences({isSnapMode:e}),this}get isDarkMode(){return this.user.isDarkMode}setDarkMode(e){return e!==this.isDarkMode&&this.user.updateUserPreferences({isDarkMode:e}),this}get animationSpeed(){return this.user.animationSpeed}setAnimationSpeed(e){return e!==this.animationSpeed&&this.user.updateUserPreferences({animationSpeed:e}),this}get instanceState(){return this.store.get(n.PQ)}get cursor(){return this.instanceState.cursor}get brush(){return this.instanceState.brush}get zoomBrush(){return this.instanceState.zoomBrush}get scribble(){return this.instanceState.scribble}get isFocusMode(){return this.instanceState.isFocusMode}setFocusMode(e){return e!==this.isFocusMode&&this.updateInstanceState({isFocusMode:e},!0),this}get isToolLocked(){return this.instanceState.isToolLocked}setToolLocked(e){return e!==this.isToolLocked&&this.updateInstanceState({isToolLocked:e},!0),this}get isGridMode(){return this.instanceState.isGridMode}setGridMode(e){return e!==this.isGridMode&&this.updateInstanceState({isGridMode:e},!0),this}get _pages(){return this.store.query.records("page")}get pages(){return this._pages.value.sort(s.hl)}get currentPage(){let e=this.getPageById(this.currentPageId);if(!e)throw Error(`No current page (id ${this.currentPageId}, ${this.pages.length} pages))`);return e}get currentPageId(){return this.instanceState.currentPageId}getPageById(e){return this.store.get(e)}getPageInfoById(e){return this.store.get(e)}_currentPageShapeIds;get currentPageShapeIds(){return this._currentPageShapeIds.value}getShapeIdsInPage(e){let t=this.store.query.exec("shape",{parentId:{eq:e}});return this.getShapeAndDescendantIds(t.map(e=>e.id))}get _pageStates(){return this.store.query.records("instance_page_state")}getPageStateByPageId(e){return this._pageStates.value.find(t=>t.pageId===e)}get pageStateId(){return n.iS.createId(this.currentPageId)}get pageState(){return this.store.get(this.pageStateId)}setInstancePageState(e,t=!1){this._setInstancePageState(e,t)}get selectedIds(){return this.pageState.selectedIds}get selectedIdsSet(){return new Set(this.selectedIds)}setSelectedIds(e,t=!1){return this._setSelectedIds(e,t),this}_setSelectedIds=this.history.createCommand("setSelectedIds",(e,t=!1)=>{let i=this.pageState.selectedIds,s=new Set(this.pageState.selectedIds);return e.length===s.size&&e.every(e=>s.has(e))?null:{data:{ids:e,prevSelectedIds:i},squashing:t,preservesRedoStack:!0}},{do:({ids:e})=>{this.store.update(this.pageState.id,t=>({...t,selectedIds:e}))},undo:({prevSelectedIds:e})=>{this.store.update(this.pageState.id,()=>({...this.pageState,selectedIds:e}))},squash:(e,t)=>({ids:t.ids,prevSelectedIds:e.prevSelectedIds})});isSelected(e){return this.selectedIdsSet.has(e)}isWithinSelection(e){let t=this.getShapeById(e);return!!t&&(!!this.isSelected(e)||!!this.findAncestor(t,e=>this.isSelected(e.id)))}select(...e){return this.setSelectedIds(e),this}deselect(...e){let{selectedIds:t}=this;return t.length>0&&e.length>0&&this.setSelectedIds(t.filter(t=>!e.includes(t))),this}selectAll(){let e=this.getSortedChildIds(this.currentPageId);return e.length<=0||this.setSelectedIds(this._getUnlockedShapeIds(e)),this}selectNone(){return this.selectedIds.length>0&&this.setSelectedIds([]),this}get focusLayerId(){return this.pageState.focusLayerId??this.currentPageId}get focusLayerShape(){let e=this.pageState.focusLayerId;if(e)return this.getShapeById(e)}popFocusLayer(){let e=this.pageState.focusLayerId,t=e&&this.getShapeById(e);if(t){let e=this.findAncestor(t,e=>this.isShapeOfType(e,z.Q));this.setFocusLayer(e?.id??null),this.select(t.id)}else this.setFocusLayer(null),this.selectNone();return this}setFocusLayer(e){return this._setFocusLayer(e),this}_setFocusLayer=this.history.createCommand("setFocusLayer",e=>{if(null===e&&!this.canUndo)return;let t=this.pageState.focusLayerId;return{data:{prev:t,next:e},preservesRedoStack:!0,squashing:!0}},{do:({next:e})=>{this.store.update(this.pageState.id,t=>({...t,focusLayerId:e}))},undo:({prev:e})=>{this.store.update(this.pageState.id,t=>({...t,focusLayerId:e}))},squash:({prev:e},{next:t})=>({prev:e,next:t})});get editingId(){return this.pageState.editingId}setEditingId(e){if(e){if(e!==this.editingId){let t=this.getShapeById(e),i=this.getShapeUtil(t);if(t&&i.canEdit(t)){this.setInstancePageState({editingId:e,hoveredId:null},!1);let{viewportPageBounds:s}=this,n=i.getEditingBounds(t),a=this.getPageTransformById(e),h=r.No.FromPoints(r.yX.applyToPoints(a,n.corners));s.contains(h)||(h.width>s.width||h.height>s.height?this.zoomToBounds(h.minX,h.minY,h.width,h.height):this.centerOnPoint(h.midX,h.midY))}}}else this.setInstancePageState({editingId:null});return this}get editingShape(){return this.editingId?this.getShapeById(this.editingId)??null:null}get hoveredId(){return this.pageState.hoveredId}setHoveredId(e=null){return e===this.pageState.hoveredId||this.setInstancePageState({hoveredId:e},!0),this}get hoveredShape(){return this.hoveredId?this.getShapeById(this.hoveredId)??null:null}get hintingIds(){return this.pageState.hintingIds}setHintingIds(e){return this.store.update(this.pageState.id,t=>({...t,hintingIds:(0,a.D8)(e)})),this}get erasingIds(){return this.pageState.erasingIds}get erasingIdsSet(){return new Set(this.erasingIds)}setErasingIds(e=[]){let t=this.erasingIdsSet;return e.length===t.size&&e.every(e=>t.has(e))||this.setInstancePageState({erasingIds:e},!0),this}get croppingId(){return this.pageState.croppingId}setCroppingId(e){if(e!==this.croppingId){if(e){let t=this.getShapeById(e),i=this.getShapeUtil(t);t&&i.canCrop(t)&&this.setInstancePageState({croppingId:e,hoveredId:null})}else this.setInstancePageState({croppingId:null}),this.isInAny("select.crop","select.pointing_crop_handle","select.cropping")&&this.setSelectedTool("select.idle")}return this}get cameraId(){return n.AN.createId(this.currentPageId)}get camera(){return this.store.get(this.cameraId)}get zoomLevel(){return this.camera.z}updateViewportScreenBounds(e=!1){let t=this.getContainer();if(!t)return this;let i=t.getBoundingClientRect(),s=new r.No(0,0,Math.max(i.width,1),Math.max(i.height,1)),n=s.equals(this.viewportScreenBounds),{_willSetInitialBounds:a}=this;if(n)this._willSetInitialBounds=!1;else if(a)this._willSetInitialBounds=!1,this.updateInstanceState({screenBounds:s.toJson()},!0,!0);else{let{zoomLevel:t}=this;if(e){let e=this.viewportPageCenter;this.updateInstanceState({screenBounds:s.toJson()},!0,!0);let i=this.viewportPageCenter;this.instanceState.followingUserId||this.pan((i.x-e.x)*t,(i.y-e.y)*t)}else{let e=this.screenToPage(0,0);this.updateInstanceState({screenBounds:s.toJson()},!0,!0);let i=this.screenToPage(0,0);this.instanceState.followingUserId||this.pan((i.x-e.x)*t,(i.y-e.y)*t)}}this._tickCameraState(),this.updateRenderingBounds();let{editingId:h}=this;return h&&this.panZoomIntoView([h]),this}get viewportScreenBounds(){let{x:e,y:t,w:i,h:s}=this.instanceState.screenBounds;return new r.No(e,t,i,s)}get viewportScreenCenter(){return this.viewportScreenBounds.center}get viewportPageBounds(){let{x:e,y:t,w:i,h:s}=this.viewportScreenBounds,n=this.screenToPage(e,t),a=this.screenToPage(e+i,t+s);return new r.No(n.x,n.y,a.x-n.x,a.y-n.y)}get viewportPageCenter(){return this.viewportPageBounds.center}screenToPage(e,t,i=.5,s=this.camera){let{screenBounds:r}=this.store.unsafeGetWithoutCapture(n.PQ),{x:a,y:h,z:o=1}=s;return{x:(e-r.x)/o-a,y:(t-r.y)/o-h,z:i}}pageToScreen(e,t,i=.5,s=this.camera){let{x:r,y:n,z:a=1}=s;return{x:e+r*a,y:t+n*a,z:i}}_cameraState=(0,d.cn)("camera state","idle");get cameraState(){return this._cameraState.value}_cameraStateTimeoutRemaining=0;_lastUpdateRenderingBoundsTimestamp=Date.now();_decayCameraStateTimeout=e=>{this._cameraStateTimeoutRemaining-=e,this._cameraStateTimeoutRemaining<=0&&(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"),this.updateRenderingBounds())};_tickCameraState=()=>{this._cameraStateTimeoutRemaining=u.yV;let e=Date.now();"idle"===this._cameraState.__unsafe__getWithoutCapture()?(this._lastUpdateRenderingBoundsTimestamp=e,this._cameraState.set("moving"),this.on("tick",this._decayCameraStateTimeout)):e-this._lastUpdateRenderingBoundsTimestamp>u.aR&&this.updateRenderingBounds()};computeUnorderedRenderingShapes(e,{renderingBounds:t,renderingBoundsExpanded:i,erasingIdsSet:s,editingId:r}={}){let a=[],h=u.kx,o=0,d=(e,l,p)=>{if(n.ez.isId(e)){for(let t of this.getSortedChildIds(e))d(t,l,p);return}let g=this.getShapeById(e);if(!g)return;let c=g.opacity*l,y=!1;!p&&s?.has(e)&&(y=!0,c*=.32);let m=this.getMaskedPageBoundsById(e),f=!!m&&(t?.includes(m)??!0),S=!m||((r!==e&&!i?.includes(m))??!0);a.push({id:e,index:h,backgroundIndex:o,opacity:c,isCulled:S,isInViewport:f,maskedPageBounds:m}),h+=1,o+=1;let I=this.getSortedChildIds(e);if(!I.length)return;let P=null;for(let e of(this.getShapeUtil(g).providesBackgroundForChildren(g)&&(P=o,o=h,h+=u.kx),I))d(e,c,p||y);null!==P&&(o=P)};for(let t of e)d(t,1,!1);return a}get renderingShapes(){let e=this.computeUnorderedRenderingShapes([this.currentPageId],{renderingBounds:this.renderingBounds,renderingBoundsExpanded:this.renderingBoundsExpanded,erasingIdsSet:this.erasingIdsSet,editingId:this.editingId});return e.sort(a.uv)}get renderingBounds(){return this._renderingBounds.value}_renderingBounds=(0,d.cn)("rendering viewport",new r.No);get renderingBoundsExpanded(){return this._renderingBoundsExpanded.value}_renderingBoundsExpanded=(0,d.cn)("rendering viewport expanded",new r.No);updateRenderingBounds(){let{viewportPageBounds:e}=this;return e.equals(this._renderingBounds.__unsafe__getWithoutCapture())||(this._renderingBounds.set(e.clone()),this._renderingBoundsExpanded.set(e.clone().expandBy(100/this.zoomLevel))),this}getTransform(e){return r.yX.Compose(r.yX.Translate(e.x,e.y),r.yX.Rotate(e.rotation))}getParentTransform(e){return(0,n.r5)(e.parentId)?r.yX.Identity():this._pageTransformCache.get(e.parentId)??r.yX.Identity()}getPageTransform(e){return this.getPageTransformById(e.id)}getPageTransformById(e){return this._pageTransformCache.get(e)}getPagePointById(e){let t=this.getPageTransformById(e);if(t)return r.yX.applyToPoint(t,new r.GF)}getPageCenter(e){let t=this.getPageTransformById(e.id);if(!t)return null;let i=this.getShapeUtil(e),s=i.center(e);return r.yX.applyToPoint(t,s)}getPageCenterById(e){let t=this.getShapeById(e);return this.getPageCenter(t)}getPageRotation(e){return this.getPageRotationById(e.id)}getPageRotationById(e){let t=this.getPageTransformById(e);return t?r.yX.Decompose(t).rotation:0}getBounds(e){return this.getShapeUtil(e).bounds(e)}getBoundsById(e){let t=this.getShapeById(e);if(t)return this.getBounds(t)}getPageBounds(e){return this.getPageBoundsById(e.id)}getPageBoundsById(e){return this._pageBoundsCache.get(e)}get _clipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{let t=this._pageMaskCache.get(e.id);if(!t)return;let i=this._pageTransformCache.get(e.id);if(!i)return;if(0===t.length)return"polygon(0px 0px, 0px 0px, 0px 0px)";let s=r.yX.applyToPoints(r.yX.Inverse(i),t);return`polygon(${s.map(e=>`${e.x}px ${e.y}px`).join(",")})`})}getClipPathById(e){return this._clipPathCache.get(e)}get _pageMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if((0,n.r5)(e.parentId))return;let t=this.getAncestorsById(e.id).filter(e=>this.isShapeOfType(e,N.U));if(0===t.length)return;let i=t.map(e=>r.yX.applyToPoints(this._pageTransformCache.get(e.id),this.getOutline(e))).reduce((e,t)=>t&&e?(0,r.tY)(e,t)??void 0:void 0);return i})}getPageMaskById(e){return this._pageMaskCache.get(e)}getMaskedPageBounds(e){return this.getMaskedPageBoundsById(e.id)}getMaskedPageBoundsById(e){let t=this._pageBoundsCache.get(e);if(!t)return;let i=this._pageMaskCache.get(e);if(i){let e=(0,r.tY)(i,t.corners);if(!e)return;return r.No.FromPoints(e)}return t}getOutline(e){return this.getShapeUtil(e).outline(e)}getOutlineById(e){return this.getOutline(this.getShapeById(e))}getAncestors(e,t=[]){let i=e.parentId;if((0,n.r5)(i))return t.reverse(),t;let s=this.store.get(i);return s?(t.push(s),this.getAncestors(s,t)):t}getAncestorsById(e,t=[]){let i=this.getShapeById(e);return i?this.getAncestors(i,t):t}findAncestor(e,t){let i=e.parentId;if((0,n.r5)(i))return;let s=this.getShapeById(i);if(s)return t(s)?s:this.findAncestor(s,t)}hasAncestor(e,t){return!!e&&(e.parentId===t||this.hasAncestor(this.getParentShape(e),t))}findCommonAncestor(e,t){if(0===e.length)return;if(1===e.length){let i=e[0].parentId;if((0,n.r5)(i))return;return t?this.findAncestor(e[0],t)?.id:i}let[i,...s]=e,r=this.getParentShape(i);for(;r;){if(t&&!t(r)){r=this.getParentShape(r);continue}if(s.every(e=>this.hasAncestor(e,r.id)))return r.id;r=this.getParentShape(r)}}isShapeOrAncestorLocked(e){return void 0!==e&&(!!e.isLocked||this.isShapeOrAncestorLocked(this.getParentShape(e)))}get allShapesCommonBounds(){let e=null;return this.currentPageShapeIds.forEach(t=>{let i=this.getMaskedPageBoundsById(t);i&&(e?e.expand(i):e=i.clone())}),e}getPageCorners(e){let t=this.getAncestors(e),i=this.getBounds(e).corners,s=r.yX.Compose(...t.flatMap(e=>[r.yX.Translate(e.x,e.y),r.yX.Rotate(e.rotation)]),r.yX.Translate(e.x,e.y),r.yX.Rotate(e.rotation,0,0));return r.yX.applyToPoints(s,i)}isPointInShape(e,t){let i=this.getShapeUtil(t),s=this._pageMaskCache.get(t.id);if(s){let t=(0,r.Of)(e,s);if(!t)return!1}return i.hitTestPoint(t,this.getPointInShapeSpace(t,e))}getShapesAtPoint(e){return this.shapesArray.filter(t=>{let i=this._pageMaskCache.get(t.id);return i?(0,r.Of)(e,i):this.getShapeUtil(t).hitTestPoint(t,this.getPointInShapeSpace(t,e))})}getPointInShapeSpace(e,t){return r.yX.applyToPoint(r.yX.Inverse(this.getPageTransform(e)),t)}getPointInParentSpace(e,t){let i=this.getShapeById(e);if(!i)return new r.GF(0,0);if((0,n.r5)(i.parentId))return r.GF.From(t);let s=this.getPageTransformById(i.parentId);return s?r.yX.applyToPoint(r.yX.Inverse(s),t):r.GF.From(t)}getDeltaInShapeSpace(e,t){let i=this.getPageTransform(e);return i?r.GF.Rot(t,-r.yX.Decompose(i).rotation):r.GF.From(t)}getDeltaInParentSpace(e,t){if((0,n.r5)(e.parentId))return r.GF.From(t);let i=this.getShapeById(e.parentId);return i?this.getDeltaInShapeSpace(i,t):r.GF.From(t)}getParentsMappedToChildren(e){let t=e.map(e=>this.store.get(e)),i=new Map;return t.forEach(e=>{i.has(e.parentId)||i.set(e.parentId,new Set),i.get(e.parentId)?.add(e)}),i}get selectedPageBounds(){let{pageState:{selectedIds:e}}=this;return 0===e.length?null:r.No.Common((0,a.oA)(e.map(e=>this.getPageBoundsById(e))))}get selectionRotation(){let{selectedIds:e}=this;if(0===e.length)return 0;if(1===e.length)return this.getPageRotationById(this.selectedIds[0]);let t=e.map(e=>this.getPageRotationById(e)%(Math.PI/2));return t.every(e=>Math.abs(e-t[0])<Math.PI/180)?this.getPageRotationById(e[0]):0}get selectionBounds(){let{selectedIds:e}=this;if(0===e.length)return;let{selectionRotation:t}=this;if(0===t)return this.selectedPageBounds;if(1===e.length){let t=this.getBounds(this.getShapeById(e[0])).clone();return t.point=r.yX.applyToPoint(this.getPageTransformById(e[0]),t.point),t}let i=this.selectedIds.flatMap(e=>{let t=this.getPageTransformById(e);return t?this.getOutlineById(e).map(e=>r.yX.applyToPoint(t,e)):[]}).map(e=>r.GF.Rot(e,-t)),s=r.No.FromPoints(i);return s.point=s.point.rot(t),s}get selectionPageCenter(){let{selectionBounds:e,selectionRotation:t}=this;return e?r.GF.RotWith(e.center,e.point,t):null}get currentToolId(){let e=this.root.current.value,t=e?.id;if("select"===t||"zoom"===t){let i=e?.current.value;t=i?.info?.onInteractionEnd??"select"}return t??"select"}setSelectedTool(e,t={}){return this.root.transition(e,t),this}getStateDescendant(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)break;let s=i.children?.[e];if(!s)return;i=s}return i}isIn(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)return!0;let s=i.current.value;if(s?.id===e){if(0===t.length)return!0;i=s;continue}break}return!1}isInAny(...e){return e.some(e=>this.isIn(e))}inputs={originPagePoint:new r.GF,originScreenPoint:new r.GF,previousPagePoint:new r.GF,previousScreenPoint:new r.GF,currentPagePoint:new r.GF,currentScreenPoint:new r.GF,keys:new Set,buttons:new Set,isPen:!1,shiftKey:!1,ctrlKey:!1,altKey:!1,isDragging:!1,isPointing:!1,isPinching:!1,isEditing:!1,isPanning:!1,pointerVelocity:new r.GF};_updateInputsFromEvent(e){let{previousScreenPoint:t,previousPagePoint:i,currentScreenPoint:s,currentPagePoint:r}=this.inputs,{screenBounds:a}=this.store.unsafeGetWithoutCapture(n.PQ),{x:h,y:o,z:d}=e.point,{x:l,y:p,z:g}=this.camera;t.setTo(s),i.setTo(r),s.set(h,o),r.set((h-a.x)/g-l,(o-a.y)/g-p,d??.5),this.inputs.isPen="pointer"===e.type&&e.isPen,"pointer_down"===e.name&&this.inputs.pointerVelocity.set(0,0),this.store.put([{id:n.LV,typeName:"pointer",x:r.x,y:r.y,lastActivityTimestamp:"pointer"===e.type&&e.pointerId===u.CK.CAMERA_MOVE?this.store.get(n.LV)?.lastActivityTimestamp??Date.now():Date.now()}])}_clickManager=new v.o(this);cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_prevCursor="default";_shiftKeyTimeout=-1;_setShiftKeyTimeout=()=>{this.inputs.shiftKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ShiftLeft"})};_altKeyTimeout=-1;_setAltKeyTimeout=()=>{this.inputs.altKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"AltLeft"})};_ctrlKeyTimeout=-1;_setCtrlKeyTimeout=()=>{this.inputs.ctrlKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ControlLeft"})};_restoreToolId="select";_pinchStart=1;_didPinch=!1;_selectedIdsAtPointerDown=[];capturedPointerId=null;dispatch(e){if(this.crashingError)return this;let{inputs:t}=this,{type:i}=e;return this.batch(()=>{if("misc"===e.type){("cancel"===e.name||"complete"===e.name)&&(this.inputs.isDragging=!1,this.inputs.isPanning&&(this.inputs.isPanning=!1,this.setCursor({type:this._prevCursor}))),this.root.handleEvent(e);return}e.shiftKey?(clearInterval(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,t.shiftKey=!0):!e.shiftKey&&t.shiftKey&&-1===this._shiftKeyTimeout&&(this._shiftKeyTimeout=setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearInterval(this._altKeyTimeout),this._altKeyTimeout=-1,t.altKey=!0):!e.altKey&&t.altKey&&-1===this._altKeyTimeout&&(this._altKeyTimeout=setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearInterval(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,t.ctrlKey=!0):!e.ctrlKey&&t.ctrlKey&&-1===this._ctrlKeyTimeout&&(this._ctrlKeyTimeout=setTimeout(this._setCtrlKeyTimeout,150));let{originPagePoint:s,originScreenPoint:n,currentPagePoint:a,currentScreenPoint:h}=t;switch(t.isPointing||(t.isDragging=!1),i){case"pinch":if(!this.canMoveCamera)return;switch(this._updateInputsFromEvent(e),e.name){case"pinch_start":if(t.isPinching)return;t.isEditing||(this._pinchStart=this.camera.z,this._selectedIdsAtPointerDown.length||(this._selectedIdsAtPointerDown=this.selectedIds.slice()),this._didPinch=!0,t.isPinching=!0,this.interrupt());return;case"pinch":{if(!t.isPinching)return;let{point:{x:i,y:s,z:r=1},delta:{x:n,y:a}}=e,{camera:{x:h,y:o,z:d}}=this,l=Math.min(u.sZ,Math.max(u.Zj,r));this.setCamera(h+n/d-i/d+i/l,o+a/d-s/d+s/l,l);return}case"pinch_end":{let e;if(!t.isPinching)return this;t.isPinching=!1;let{_selectedIdsAtPointerDown:i}=this;this.setSelectedIds(this._selectedIdsAtPointerDown,!0),this._selectedIdsAtPointerDown=[];let{camera:{x:s,y:r,z:n}}=this;if(n>.9&&n<1.05?e=1:n>.49&&n<.505&&(e=.5),n>this._pinchStart-.1&&n<this._pinchStart+.05&&(e=this._pinchStart),void 0!==e){let{x:t,y:i}=this.viewportScreenCenter;this.animateCamera(s+(t/e-t)-(t/n-t),r+(i/e-i)-(i/n-i),e,{duration:100})}this._didPinch&&(this._didPinch=!1,requestAnimationFrame(()=>{this._didPinch||this.setSelectedIds(i,!0)}));return}}case"wheel":if(!this.canMoveCamera)return;if(this.isMenuOpen);else{if(t.ctrlKey){let{x:t,y:i}=this.inputs.currentScreenPoint,{x:s,y:r,z:n}=this.camera,a=Math.min(u.sZ,Math.max(u.Zj,n+(e.delta.z??0)*n));this.setCamera(s+(t/a-t)-(t/n-t),r+(i/a-i)-(i/n-i),a);return}this.pan(e.delta.x,e.delta.y),!t.isDragging&&t.isPointing&&s.dist(a)>(this.isCoarsePointer?u.UD:u.Sk)/this.zoomLevel&&(t.isDragging=!0)}break;case"pointer":{if(t.isPinching)return;this._updateInputsFromEvent(e);let{isPen:i}=e;switch(e.name){case"pointer_down":if(this._selectedIdsAtPointerDown=this.selectedIds.slice(),0===e.button&&(this.capturedPointerId=e.pointerId),t.buttons.add(e.button),t.isPointing=!0,t.isDragging=!1,this.isPenMode){if(i)this._touchEventsRemainingBeforeExitingPenMode=3;else{if(this._touchEventsRemainingBeforeExitingPenMode--,0!==this._touchEventsRemainingBeforeExitingPenMode)return;this.setPenMode(!1)}}else i&&this.setPenMode(!0);if(5===e.button?(this._restoreToolId=this.currentToolId,this.complete(),this.setSelectedTool("eraser")):1===e.button&&(this.inputs.isPanning||(this._prevCursor=this.instanceState.cursor.type),this.inputs.isPanning=!0),this.inputs.isPanning)return this.stopCameraAnimation(),this.setCursor({type:"grabbing"}),this;n.setTo(h),s.setTo(a);break;case"pointer_move":if(!i&&this.isPenMode)return;if(this.inputs.isPanning&&this.inputs.isPointing){let{currentScreenPoint:e,previousScreenPoint:t}=this.inputs,i=r.GF.Sub(e,t);this.pan(i.x,i.y);return}!t.isDragging&&t.isPointing&&s.dist(a)>(this.isCoarsePointer?u.UD:u.Sk)/this.zoomLevel&&(t.isDragging=!0);break;case"pointer_up":if(t.buttons.delete(e.button),t.isPointing=!1,t.isDragging=!1,this.isMenuOpen||!i&&this.isPenMode)return;this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),t.isPanning?1===e.button?this.inputs.keys.has(" ")?(this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:u.IG}),this.setCursor({type:"grab"})):(t.isPanning=!1,this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:u.IG}),this.setCursor({type:this._prevCursor})):0===e.button&&(this.slideCamera({speed:Math.min(2,this.inputs.pointerVelocity.len()),direction:this.inputs.pointerVelocity,friction:u.IG}),this.setCursor({type:"grab"})):5===e.button&&(this.complete(),this.setSelectedTool(this._restoreToolId))}break}case"keyboard":switch("ShiftRight"===e.key&&(e.key="ShiftLeft"),"AltRight"===e.key&&(e.key="AltLeft"),"ControlRight"===e.code&&(e.code="ControlLeft"),e.name){case"key_down":t.keys.add(e.code),e.ctrlKey||"Space"!==e.code||(this.inputs.isPanning||(this._prevCursor=this.instanceState.cursor.type),this.inputs.isPanning=!0,this.setCursor({type:this.inputs.isPointing?"grabbing":"grab"}));break;case"key_up":t.keys.delete(e.code),"Space"!==e.code||this.inputs.buttons.has(1)||(this.inputs.isPanning=!1,this.setCursor({type:this._prevCursor}))}}if("pointer"===e.type&&(1===e.button?e.name="middle_click":2===e.button&&(e.name="right_click"),e.isPen===this.isPenMode))switch(e.name){case"pointer_down":{let t=this._clickManager.transformPointerDownEvent(e);if(e.name!==t.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(t),this.emit("event",t);return}break}case"pointer_up":{let t=this._clickManager.transformPointerUpEvent(e);if(e.name!==t.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(t),this.emit("event",t);return}break}case"pointer_move":this._clickManager.handleMove()}this.root.handleEvent(e),this.emit("event",e)}),this}replaceStoreContentsWithRecordsForOtherDocument(e){(0,d.ay)(()=>{this.store.clear();let[t,i]=(0,a.uK)(e,e=>"shape"===e.typeName);this.store.put(i,"initialize"),this.store.ensureStoreIsUsable(),this.store.put(t,"initialize"),this.history.clear(),this.updateViewportScreenBounds(),this.updateRenderingBounds();let s=this.allShapesCommonBounds;s&&this.zoomToBounds(s.minX,s.minY,s.width,s.height,1)})}getContent(e=this.selectedIds){if(!e||0===e.length)return;let t={},i=(0,a.D8)(e.map(e=>this.getShapeById(e)).sort(s.hl).flatMap(e=>{let t=[e];return this.visitDescendants(e.id,e=>{t.push(this.getShapeById(e))}),t}));i=i.map(e=>{if(t[e.id]=this.getPageTransformById(e.id),e=(0,a.v4)(e),this.isShapeOfType(e,k.Y)){let t="binding"===e.props.start.type?e.props.start.boundShapeId:void 0,s="binding"===e.props.end.type?e.props.end.boundShapeId:void 0,n=this.getShapeUtil(k.Y).getArrowInfo(e);if("binding"===e.props.start.type&&!i.some(e=>e.id===t)){if(n?.isValid){let{x:t,y:i}=n.start.point;e.props.start={type:"point",x:t,y:i}}else{let{start:t}=(0,O.Qs)(this,e);e.props.start={type:"point",x:t.x,y:t.y}}}if("binding"===e.props.end.type&&!i.some(e=>e.id===s)){if(n?.isValid){let{x:t,y:i}=n.end.point;e.props.end={type:"point",x:t,y:i}}else{let{end:t}=(0,O.Qs)(this,e);e.props.end={type:"point",x:t.x,y:t.y}}}let a=(0,O.el)(e)?(0,R.rc)(this,e):(0,E.pe)(this,e);if(n?.isValid&&a?.isValid&&!(0,O.el)(e)){let t=r.GF.Med(n.start.handle,n.end.handle),i=r.GF.Dist(n.middle,t),s=r.GF.Dist(a.middle,t);e.props.bend<0?e.props.bend+=s-i:e.props.bend-=s-i}}return e});let n=[];i.forEach(e=>{if(void 0===i.find(t=>t.id===e.parentId)){let t=this.getPagePointById(e.id),i=this.getPageRotationById(e.id);e.x=t.x,e.y=t.y,e.rotation=i,e.parentId=this.currentPageId,n.push(e.id)}});let h=new Set;return i.forEach(e=>{"assetId"in e.props&&null!==e.props.assetId&&h.add(e.props.assetId)}),{shapes:i,rootShapeIds:n,schema:this.store.schema.serialize(),assets:(0,a.oA)(Array.from(h).map(e=>this.getAssetById(e)))}}putContent(e,t={}){if(this.isReadOnly)return this;if(!e.schema)throw Error("Could not put content: content is missing a schema.");let{select:i=!1,preserveIds:h=!1,preservePosition:o=!1}=t,{point:d}=t,{currentPageId:l}=this,{assets:p,shapes:g,rootShapeIds:c}=e,y=new Map(g.map(e=>[e.id,(0,n.F1)()])),f=this.currentPageId,S=1/0,I=[];for(let e of this.selectedShapes){if(0===S)break;let t=this.isShapeOfType(e,N.U),i=this.getAncestors(e);t&&i.push(e);let s=t?i.length+1:i.length;if(s<S)S=s,I=i,f=t?e.id:e.parentId;else if(s===S){if(I.length!==i.length)throw Error(`Ancestors: ${I.length} !== ${i.length}`);if(0===I.length){f=l;break}f=l;for(let e=0;e<I.length&&i[e]===I[e];e++)f=i[e].id}}let P=!1;if(!(0,n.r5)(f)){let e=this.getShapeById(f);if(e){if(this.viewportPageBounds.includes(this.getPageBounds(e))){if(1===c.length){let t=g.find(e=>e.id===c[0]);this.isShapeOfType(e,N.U)&&this.isShapeOfType(t,N.U)&&t.props.w===e?.props.w&&t.props.h===e?.props.h&&(P=!0)}}else f=l}else f=l}P||(P=y.has(f)),P&&(f=this.getShapeById(f).parentId);let w=this.getHighestIndexForParent(f),_=[],v=g.map(e=>{let t;if(h)t=(0,a.p$)(e),y.set(e.id,e.id);else{let i=y.get(e.id);t=(0,a.p$)({...e,id:i})}if(c.includes(e.id)&&(t.parentId=l,_.push(t)),y.has(t.parentId)?t.parentId=y.get(e.parentId):(c.push(t.id),t.index=w,w=(0,s._L)(w)),this.isShapeOfType(t,k.Y)){if("binding"===t.props.start.type){let e=y.get(t.props.start.boundShapeId);t.props.start=e?{...t.props.start,boundShapeId:e}:{type:"point",x:0,y:0}}if("binding"===t.props.end.type){let e=y.get(t.props.end.boundShapeId);t.props.end=e?{...t.props.end,boundShapeId:e}:{type:"point",x:0,y:0}}}return t});if(v.length+this.currentPageShapeIds.size>u.kx)return Y(this),this;let x=[];if(p){for(let t=0;t<p.length;t++){let i=p[t],s=this.store.schema.migratePersistedRecord(i,e.schema);if("success"===s.type)p[t]=s.value;else throw Error(`Could not put content: could not migrate content for asset:
${JSON.stringify(i,null,2)}`)}let t=[];x=p.filter(e=>!this.store.has(e.id)).map(e=>(("image"===e.type||"video"===e.type)&&(e.props.src&&e.props.src?.startsWith("data:image")?(t.push((0,a.v4)(e)),e.props.src=null):t.push((0,a.v4)(e))),e)),Promise.allSettled(t.map(async e=>{let t=await (0,m.Bo)(e.props.src,e.props.name,e.props.mimeType??"image/png"),i=await this.externalContentManager.createAssetFromFile(this,t);return[e,i]})).then(e=>{this.updateAssets((0,a.oA)(e.map(e=>"fulfilled"===e.status?{...e.value[1],id:e.value[0].id}:void 0)))})}for(let t=0;t<v.length;t++){let i=v[t],s=this.store.schema.migratePersistedRecord(i,e.schema);if("success"===s.type)v[t]=s.value;else throw Error(`Could not put content: could not migrate content for shape:
${JSON.stringify(i,null,2)}`)}return this.batch(()=>{x.length>0&&this.createAssets(x),this.createShapes(v,i),f!==l&&this.reparentShapesById(_.map(e=>e.id),f);let e=v.map(e=>this.getShapeById(e.id)),t=r.No.Common(e.map(e=>this.getPageBounds(e)));if(void 0===d){if((0,n.r5)(f)){let{viewportPageBounds:e}=this;d=o||e.includes(r.No.From(t))?t.center:e.center}else{let e=this.getShapeById(f),t=this.getShapeUtil(e);d=t.center(e)}}if(1===_.length){let e=_[0];if(this.isShapeOfType(e,N.U))for(;this.getShapesAtPoint(d).some(t=>this.isShapeOfType(t,N.U)&&t.props.w===e.props.w&&t.props.h===e.props.h);)d.x+=t.w+16}this.updateShapes(_.map(e=>{let i={x:(e.x??0)-(t.x+t.w/2),y:(e.y??0)-(t.y+t.h/2)};return{id:e.id,type:e.type,x:d.x+i.x,y:d.y+i.y}}))}),this}createShapes(e,t=!1){return this._createShapes(e,t),this}_createShapes=this.history.createCommand("createShapes",(e,t=!1)=>{if(this.isReadOnly||e.length<=0)return null;let{currentPageShapeIds:i,selectedIds:s}=this,r=e.length+i.size>u.kx;r&&Y(this);let n=r?e.slice(0,u.kx-i.size):e;return 0===n.length?null:{data:{currentPageId:this.currentPageId,createdIds:e.map(e=>e.id),prevSelectedIds:t?s:void 0,partials:n,select:t}}},{do:({createdIds:e,partials:t,select:i})=>{let{focusLayerId:r}=this;t=t.map(e=>{if(!e.parentId||!this.store.get(e.parentId)&&!t.find(t=>t.id===e.parentId)){e={...e};let t=this.getParentIdForNewShapeAtPoint({x:e.x??0,y:e.y??0},e.type);if(e.parentId=t,(0,n.YT)(t)){let i=this.getPointInShapeSpace(this.getShapeById(t),{x:e.x??0,y:e.y??0});e.x=i.x,e.y=i.y,e.rotation=-this.getPageRotationById(t)+(e.rotation??0)}e.parentId===e.id&&(e.parentId=r)}return e});let a=new Map,h=[];for(let e of t){let t=this.getShapeUtil(e),i=e.index;if(!i){let t=e.parentId??r;a.has(t)||a.set(t,this.getHighestIndexForParent(t)),i=a.get(t),a.set(t,(0,s._L)(i))}let n=t.defaultProps();for(let[e,i]of t.styleProps)n[i]=this.getStyleForNextShape(e);let o=this.store.schema.types.shape.create({...e,index:i,opacity:e.opacity??this.instanceState.opacityForNextShape,parentId:e.parentId??r,props:"props"in e?{...n,...e.props}:n});if(void 0===o.index)throw Error("no index!");let d=this.getShapeUtil(o).onBeforeCreate?.(o);d&&(o=d),h.push(o)}this.store.put(h),i&&this.store.update(this.pageState.id,t=>({...t,selectedIds:e}))},undo:({createdIds:e,prevSelectedIds:t})=>{this.store.remove(e),t&&this.store.update(this.pageState.id,e=>({...e,selectedIds:t}))}});animatingShapes=new Map;animateShapes(e,t={}){let i,s;let{duration:n=500,ease:a=r.Lj.linear}=t,h=(0,f.EL)(),o=n,d=[];e.forEach(e=>{if(!e)return;let t={partial:e,values:[]},i=this.getShapeById(e.id);if(i){for(let s of["x","y","rotation"])void 0!==e[s]&&i[s]!==e[s]&&t.values.push({prop:s,from:i[s],to:e[s]});d.push(t),this.animatingShapes.set(i.id,h)}});let l=t=>{if((o-=t)<0){let{animatingShapes:t}=this,i=e.filter(e=>e&&t.get(e.id)===h);i.length&&this.updateShapes(i,!1),this.removeListener("tick",l);return}i=a(1-o/n);let{animatingShapes:r}=this;try{let e=[];for(let t=0;t<d.length;t++)s=d[t],r.get(s.partial.id)===h&&e.push({id:s.partial.id,type:s.partial.type,...s.values.reduce((e,{prop:t,from:s,to:r})=>(e[t]=s+(r-s)*i,e),{})});this._updateShapes(e,!0)}catch(e){}};return this.addListener("tick",l),this}updateShapes(e,t=!1){let i=(0,a.oA)(e);return this.animatingShapes.size>0&&i.forEach(e=>this.animatingShapes.delete(e.id)),i=i.filter(e=>{let t=this.getShapeById(e.id);return!(!t||this.isShapeOrAncestorLocked(t)&&!Object.hasOwn(e,"isLocked"))}),this._updateShapes(i,t),this}_updateShapes=this.history.createCommand("updateShapes",(e,t=!1)=>{if(this.isReadOnly)return null;let i=(0,a.oA)(e),s=Object.fromEntries((0,a.oA)(i.map(({id:e})=>this.getShapeById(e))).map(e=>[e.id,e]));if(i.length<=0)return null;let r=(0,a.oA)(i.map(e=>{let t=s[e.id];if(!t)return null;let i=null;for(let[s,r]of Object.entries(e))if(void 0!==r)switch(s){case"id":case"type":case"typeName":continue;default:if(r!==t[s]){if(i||(i={...t}),"props"===s){let e={...t.props};for(let[t,i]of Object.entries(r))void 0!==i&&(e[t]=i);i.props=e}else i[s]=r}}return i??t})),n=Object.fromEntries(r.map(e=>[e.id,e]));return{data:{snapshots:s,updates:n},squashing:t}},{do:({updates:e})=>{let t=Object.values(e);for(let e=0;e<t.length;e++){let i=t[e],s=this.store.get(i.id);if(!s)continue;let r=this.getShapeUtil(i).onBeforeUpdate?.(s,i);r&&(t[e]=r)}this.store.put(t)},undo:({snapshots:e})=>{this.store.put(Object.values(e))},squash:(e,t)=>({snapshots:{...t.snapshots,...e.snapshots},updates:{...e.updates,...t.updates}})});_getUnlockedShapeIds(e){return e.filter(e=>!this.getShapeById(e)?.isLocked)}deleteShapes(e=this.selectedIds){return this._deleteShapes(this._getUnlockedShapeIds(e)),this}_deleteShapes=this.history.createCommand("delete_shapes",e=>{if(this.isReadOnly||0===e.length)return null;let t=[...this.pageState.selectedIds],i=new Set(e);for(let t of e)this.visitDescendants(t,e=>{i.add(e)});let s=[...i],r=this._arrowBindingsIndex.value,n=(0,a.oA)(s.flatMap(e=>{let t=this.getShapeById(e),i=r[e];return i&&i.length>0?i.map(({arrowId:e})=>this.getShapeById(e)).concat(t):t})),h=t.filter(e=>!i.has(e));return{data:{deletedIds:s,snapshots:n,prevSelectedIds:t,postSelectedIds:h}}},{do:({deletedIds:e,postSelectedIds:t})=>{this.store.remove(e),this.store.update(this.pageState.id,e=>({...e,selectedIds:t}))},undo:({snapshots:e,prevSelectedIds:t})=>{this.store.put(e),this.store.update(this.pageState.id,e=>({...e,selectedIds:t}))}});get locale(){return this.user.locale}setLocale(e){this.user.updateUserPreferences({locale:e})}updatePage(e,t=!1){return this._updatePage(e,t),this}_updatePage=this.history.createCommand("updatePage",(e,t=!1)=>{if(this.isReadOnly)return null;let i=this.getPageById(e.id);return i?{data:{prev:i,partial:e},squashing:t}:null},{do:({partial:e})=>{this.store.update(e.id,t=>({...t,...e}))},undo:({prev:e,partial:t})=>{this.store.update(t.id,()=>e)},squash:(e,t)=>({prev:{...e.prev,...t.prev},partial:t.partial})});createPage(e,t=n.ez.createId(),i){return this._createPage(e,t,i),this}_createPage=this.history.createCommand("createPage",(e,t=n.ez.createId(),i)=>{if(this.isReadOnly||this.pages.length>=u.Et)return null;let r=this.pages,a=i??r[r.length-1]?.index??"a1",h=r[r.findIndex(e=>e.index===a)+1]?.index;e=(0,f.u2)(e,r.map(e=>e.name));let o=n.ez.create({id:t,name:e,index:h&&a!==h?(0,s.eI)(a,h):(0,s._L)(a)}),d=n.AN.create({id:n.AN.createId(o.id)}),l=n.iS.create({id:n.iS.createId(o.id),pageId:o.id});return{data:{prevSelectedPageId:this.currentPageId,newPage:o,newTabPageState:l,newCamera:d}}},{do:({newPage:e,newTabPageState:t,newCamera:i})=>{this.store.put([e,i,t,{...this.instanceState,currentPageId:e.id}]),this.updateRenderingBounds()},undo:({newPage:e,prevSelectedPageId:t,newTabPageState:i,newCamera:s})=>{1!==this.pages.length&&(this.store.remove([i.id,e.id,s.id]),this.store.has(t)&&this.currentPageId!==t&&this.store.put([{...this.instanceState,currentPageId:t}]),this.updateRenderingBounds())}});duplicatePage(e=this.currentPageId,t=n.ez.createId()){if(this.pages.length>=u.Et)return this;let i=this.getPageById(e);if(!i)return this;let s={...this.camera},r=this.getContent(this.getSortedChildIds(i.id));return this.batch(()=>{if(this.createPage(i.name+" Copy",t,i.index),this.setCurrentPageId(t),this.setCamera(s.x,s.y,s.z),r)return this.putContent(r)}),this}deletePage(e){this._deletePage(e)}_deletePage=this.history.createCommand("delete_page",e=>{if(this.isReadOnly)return null;let{pages:t}=this;if(1===t.length)return null;let i=this.getPageById(e),s=this._pageStates.value.filter(t=>t.pageId===e);if(!i)return null;if(e===this.currentPageId){let i=t.findIndex(t=>t.id===e),s=t[i-1]??t[i+1];this.setCurrentPageId(s.id)}return{data:{id:e,deletedPage:i,deletedPageStates:s}}},{do:({deletedPage:e,deletedPageStates:t})=>{let{pages:i}=this;if(1!==i.length){if(e.id===this.currentPageId){let t=i.findIndex(t=>t.id===e.id),s=i[t-1]??i[t+1];this.setCurrentPageId(s.id)}this.store.remove(t.map(e=>e.id)),this.store.remove([e.id]),this.updateRenderingBounds()}},undo:({deletedPage:e,deletedPageStates:t})=>{this.store.put([e]),this.store.put(t),this.updateRenderingBounds()}});_setInstancePageState=this.history.createCommand("setInstancePageState",(e,t=!1)=>{let i=this.store.get(e.id??this.pageState.id);return{data:{prev:i,partial:e},ephemeral:t}},{do:({prev:e,partial:t})=>{this.store.update(e.id,e=>({...e,...t}))},undo:({prev:e})=>{this.store.update(e.id,()=>e)}});get _assets(){return this.store.query.records("asset")}get assets(){return this._assets.value}createAssets(e){return this._createAssets(e),this}_createAssets=this.history.createCommand("createAssets",e=>this.isReadOnly||e.length<=0?null:{data:{assets:e}},{do:({assets:e})=>{this.store.put(e)},undo:({assets:e})=>{this.store.remove(e.map(e=>e.id))}});deleteAssets(e){return this._deleteAssets(e),this}_deleteAssets=this.history.createCommand("deleteAssets",e=>{if(this.isReadOnly||e.length<=0)return;let t=(0,a.oA)(e.map(e=>this.store.get(e)));return{data:{ids:e,prev:t}}},{do:({ids:e})=>{this.store.remove(e)},undo:({prev:e})=>{this.store.put(e)}});updateAssets(e){return this._updateAssets(e),this}_updateAssets=this.history.createCommand("updateAssets",e=>{if(!this.isReadOnly&&!(e.length<=0))return{data:{snapshots:{},assets:e}}},{do:({assets:e,snapshots:t})=>{this.store.put(e.map(e=>{let i=this.store.get(e.id);return t[e.id]=i,{...i,...e}}))},undo:({snapshots:e})=>{this.store.put(Object.values(e))}});getAssetBySrc(e){return this.assets.find(t=>t.props.src===e)}getAssetById(e){return this.store.get(e)}renamePage(e,t,i=!1){return this.isReadOnly||this.updatePage({id:e,name:t},i),this}moveShapesToPage(e,t){if(0===e.length||this.isReadOnly)return this;let{currentPageId:i}=this;if(t===i||!this.store.has(t))return this;let s=this.getContent(e);if(!s)return this;if(this.getShapeIdsInPage(t).size+s.shapes.length>u.kx)return Y(this,t),this;let r=this.camera.z;return this.history.batch(()=>{this.deleteShapes(e),this.setCurrentPageId(t),this.setFocusLayer(null),this.selectNone(),this.putContent(s,{select:!0,preserveIds:!0,preservePosition:!0});let{center:{x:i,y:n}}=this.selectionBounds;this.setCamera(this.camera.x,this.camera.y,r),this.centerOnPoint(i,n)}),this}toggleLock(e=this.selectedIds){if(this.isReadOnly||0===e.length)return this;let t=!0,i=!0,s=[];for(let r of e){let e=this.getShapeById(r);e&&(s.push(e),e.isLocked?i=!1:t=!1)}return i?(this.updateShapes(s.map(e=>({id:e.id,type:e.type,isLocked:!0}))),this.setSelectedIds([])):t?this.updateShapes(s.map(e=>({id:e.id,type:e.type,isLocked:!1}))):this.updateShapes(s.map(e=>({id:e.id,type:e.type,isLocked:!0}))),this}reorderShapes(e,t){if(this.isReadOnly||0===t.length)return this;let i=this.getParentsMappedToChildren(t),r=[];switch(e){case"toBack":i.forEach((e,t)=>{let i,n;let h=(0,a.oA)(this.getSortedChildIds(t).map(e=>this.getShapeById(e)));if(e.size===h.length)return;for(let t of h){if(!e.has(t)){n=t.index;break}e.delete(t),i=t.index}if(0===e.size)return;let o=(0,s.Xv)(i,n,e.size);Array.from(e.values()).sort(s.hl).forEach((e,t)=>r.push({id:e.id,type:e.type,index:o[t]}))});break;case"toFront":i.forEach((e,t)=>{let i,n;let h=(0,a.oA)(this.getSortedChildIds(t).map(e=>this.getShapeById(e))),o=h.length;if(e.size===o)return;for(let t=o-1;t>-1;t--){let s=h[t];if(!e.has(s)){i=s.index;break}e.delete(s),n=s.index}if(0===e.size)return;let d=(0,s.Xv)(i,n,e.size);Array.from(e.values()).sort(s.hl).forEach((e,t)=>r.push({id:e.id,type:e.type,index:d[t]}))});break;case"forward":i.forEach((e,t)=>{let i,n,h;let o=(0,a.oA)(this.getSortedChildIds(t).map(e=>this.getShapeById(e))),d=o.length;if(e.size===d)return;let l=new Set(Array.from(e).map(e=>o.indexOf(e))),p=-1,u=!1;for(let e=0;e<d;e++){let t=l.has(e);if(!u&&t)u=!0,p=e,n=void 0;else if(u&&!t){u=!1,h=e-p,i=o[e].index,n=o[e+1]?.index;let t=(0,s.Xv)(i,n,h);for(let e=0;e<h;e++){let i=o[p+e];r.push({id:i.id,type:i.type,index:t[e]})}}}});break;case"backward":i.forEach((e,t)=>{let i;let n=(0,a.oA)(this.getSortedChildIds(t).map(e=>this.getShapeById(e))),h=n.length;if(e.size===h)return;let o=new Set(Array.from(e).map(e=>n.indexOf(e))),d=-1,l=!1;for(let e=h-1;e>-1;e--){let t=o.has(e);if(!l&&t)l=!0,d=e;else if(l&&!t){l=!1,i=d-e;let t=(0,s.Xv)(n[e-1]?.index,n[e].index,i);for(let s=0;s<i;s++){let i=n[e+s+1];r.push({id:i.id,type:i.type,index:t[s]})}}}})}return this.updateShapes(r),this}sendToBack(e=this.pageState.selectedIds){return this.reorderShapes("toBack",e),this}sendBackward(e=this.pageState.selectedIds){return this.reorderShapes("backward",e),this}bringForward(e=this.pageState.selectedIds){return this.reorderShapes("forward",e),this}bringToFront(e=this.pageState.selectedIds){return this.reorderShapes("toFront",e),this}flipShapes(e,t=this.selectedIds){if(this.isReadOnly)return this;let i=(0,a.oA)(t.map(e=>this.getShapeById(e)));if(!i.length)return this;i=(0,a.oA)(i.map(e=>this.isShapeOfType(e,z.Q)?this.getSortedChildIds(e.id).map(e=>this.getShapeById(e)):e).flat());let s=r.No.Common((0,a.oA)(i.map(e=>this.getPageBounds(e)))).center;return this.batch(()=>{for(let t of i){let i=this.getShapeUtil(t),r=i.bounds(t),n=this.getPageTransformById(t.id);n&&this.resizeShape(t.id,{x:"horizontal"===e?-1:1,y:"vertical"===e?-1:1},{initialBounds:r,initialPageTransform:n,initialShape:t,mode:"scale_shape",scaleOrigin:s,scaleAxisRotation:0})}}),this}stackShapes(e,t=this.pageState.selectedIds,i){let s,n,h,o,d;if(this.isReadOnly)return this;let l=(0,a.oA)(t.map(e=>this.getShapeById(e))).filter(e=>!(!e||this.isShapeOfType(e,k.Y)&&("binding"===e.props.start.type||"binding"===e.props.end.type))),p=l.length;if(void 0===i&&p<3||p<2)return this;let u=Object.fromEntries(l.map(e=>[e.id,this.getPageBounds(e)]));if("horizontal"===e?(s="x",n="minX",h="maxX",o="width"):(s="y",n="minY",h="maxY",o="height"),void 0===i){let e=[];l.sort((e,t)=>u[e.id][n]-u[t.id][n]);for(let t=0;t<p-1;t++){let i=l[t],s=l[t+1],r=u[i.id],a=u[s.id],o=a[n]-r[h],d=e.find(e=>e.gap===o);d?d.count++:e.push({gap:o,count:1})}let t=0;e.forEach(e=>{e.count>t&&(t=e.count,d=e.gap)}),1===t&&(d=Math.max(0,e.reduce((e,t)=>e+t.gap*t.count,0)/(p-1)))}else d=i;let g=[],c=u[l[0].id][h];return l.forEach((e,t)=>{if(0===t)return;let i={x:0,y:0};i[s]=c+d-u[e.id][s];let n=this.getParentShape(e),a=n?r.GF.Rot(i,-this.getPageRotation(n)):i,h=this.getShapeUtil(e).onTranslateStart?.(e);g.push(h?{...h,[s]:e[s]+a[s]}:{id:e.id,type:e.type,[s]:e[s]+a[s]}),c+=u[e.id][o]+d}),this.updateShapes(g),this}packShapes(e=this.pageState.selectedIds,t=16){let i,s,n;if(this.isReadOnly||e.length<2)return this;let h=(0,a.oA)(e.map(e=>this.getShapeById(e)).filter(e=>!(!e||this.isShapeOfType(e,k.Y)&&("binding"===e.props.start.type||"binding"===e.props.end.type)))),o={},d={},l,p,u=0;for(let e=0;e<h.length;e++)l=h[e],p=this.getPageBounds(l),o[l.id]=p,d[l.id]=p.clone(),u+=p.width*p.height;let g=r.No.Common((0,a.oA)(Object.values(o))),c=g.width;h.sort((e,t)=>o[t.id].height-o[e.id].height);let y=Math.max(Math.ceil(Math.sqrt(u/.95)),c),m=[new r.No(g.x,g.y,y,1/0)],f=0,S=0;for(let e=0;e<h.length;e++){p=d[(l=h[e]).id];for(let e=m.length-1;e>=0;e--)if(i=m[e],!(p.width>i.width)&&!(p.height>i.height)){p.x=i.x,p.y=i.y,S=Math.max(S,p.maxY),f=Math.max(f,p.maxX),p.width===i.width&&p.height===i.height?(s=m.pop(),e<m.length&&(m[e]=s)):p.height===i.height?(i.x+=p.width+t,i.width-=p.width+t):p.width===i.width?(i.y+=p.height+t,i.height-=p.height+t):(m.push(new r.No(i.x+(p.width+t),i.y,i.width-(p.width+t),p.height)),i.y+=p.height+t,i.height-=p.height+t);break}}let I=r.No.Common(Object.values(d)),P=r.GF.Sub(g.center,I.center),w=[];for(let e=0;e<h.length;e++){p=o[(l=h[e]).id],n=d[l.id];let t=this.getDeltaInParentSpace(l,r.GF.Sub(n.point,p.point).add(P)),i={id:l.id,type:l.type,x:l.x+t.x,y:l.y+t.y},s=this.getShapeUtil(l).onTranslateStart?.({...l,...i});s?w.push({...i,...s}):w.push(i)}return w.length&&this.updateShapes(w),this}alignShapes(e,t=this.pageState.selectedIds){if(this.isReadOnly||t.length<2)return this;let i=(0,a.oA)(t.map(e=>this.getShapeById(e))),s=Object.fromEntries(i.map(e=>[e.id,this.getPageBounds(e)])),n=r.No.Common((0,a.oA)(Object.values(s))),h=[];return i.forEach(t=>{let i=s[t.id];if(!i)return;let a={x:0,y:0};switch(e){case"top":a.y=n.minY-i.minY;break;case"center-vertical":a.y=n.midY-i.minY-i.height/2;break;case"bottom":a.y=n.maxY-i.minY-i.height;break;case"left":a.x=n.minX-i.minX;break;case"center-horizontal":a.x=n.midX-i.minX-i.width/2;break;case"right":a.x=n.maxX-i.minX-i.width}let o=this.getParentShape(t),d=o?r.GF.Rot(a,-this.getPageRotation(o)):a,l=this.getShapeUtil(t).onTranslateStart?.(t);h.push(l?{...l,x:t.x+d.x,y:t.y+d.y}:{id:t.id,type:t.type,x:t.x+d.x,y:t.y+d.y})}),this.updateShapes(h),this}distributeShapes(e,t=this.pageState.selectedIds){let i,s,n,h,o;if(this.isReadOnly||t.length<3)return this;let d=t.length,l=(0,a.oA)(t.map(e=>this.getShapeById(e))),p=Object.fromEntries(l.map(e=>[e.id,this.getPageBounds(e)]));"horizontal"===e?(i="x",s="minX",n="maxX",h="midX",o="width"):(i="y",s="minY",n="maxY",h="midY",o="height");let u=[],g=l.sort((e,t)=>p[e.id][s]-p[t.id][s])[0],c=l.sort((e,t)=>p[t.id][n]-p[e.id][n])[0],y=p[g.id][h],m=(p[c.id][h]-y)/(d-1),f=y+m;return l.filter(e=>e!==g&&e!==c).sort((e,t)=>p[e.id][h]-p[t.id][h]).forEach((e,t)=>{let s={x:0,y:0};s[i]=f+m*t-p[e.id][o]/2-p[e.id][i];let n=this.getParentShape(e),a=n?r.GF.Rot(s,-this.getPageRotation(n)):s,h=this.getShapeUtil(e).onTranslateStart?.(e);u.push(h?{...h,[i]:e[i]+a[i]}:{id:e.id,type:e.type,[i]:e[i]+a[i]})}),this.updateShapes(u),this}_resizeUnalignedShape(e,t,i){let{type:s}=i.initialShape,n=new r.GF(t.x,t.y);if(Math.abs(t.x)>Math.abs(t.y)?n.x=Math.sign(t.x)*Math.abs(t.y):n.y=Math.sign(t.y)*Math.abs(t.x),this.resizeShape(e,n,{initialShape:i.initialShape,initialBounds:i.initialBounds}),Math.sign(t.x)*Math.sign(t.y)<0){let{rotation:t}=r.yX.Decompose(i.initialPageTransform);t-=2*t,this.updateShapes([{id:e,type:s,rotation:t}],!0)}let a=r.yX.applyToPoint(i.initialPageTransform,i.initialBounds.center),h=this._scalePagePoint(a,i.scaleOrigin,t,i.scaleAxisRotation),o=this.getPageCenterById(e),d=this.getPagePointById(e);if(!o||!d)return this;let l=r.GF.Sub(h,o),p=r.GF.Add(d,l),{x:u,y:g}=this.getPointInParentSpace(e,p);return this.updateShapes([{id:e,type:s,x:u,y:g}],!0),this}_scalePagePoint(e,t,i,s){let n=r.GF.RotWith(e,t,-s).sub(t),a=r.GF.MulV(n,i),h=r.GF.Add(a,t).rotWith(t,s);return h}resizeShape(e,t,i={}){if(this.isReadOnly)return this;Number.isFinite(t.x)||(t=new r.GF(1,t.y)),Number.isFinite(t.y)||(t=new r.GF(t.x,1));let s=i.initialShape??this.getShapeById(e);if(!s)return this;let n=i.scaleOrigin??this.getPageBoundsById(e)?.center;if(!n)return this;let a=this.getPageRotationById(e);if(null==a)return this;let h=i.scaleAxisRotation??a,o=i.initialPageTransform??this.getPageTransformById(e);if(!o)return this;let d=i.initialBounds??this.getBoundsById(e);if(!d)return this;if(!(0,r._G)(a,h))return this._resizeUnalignedShape(e,t,{...i,initialBounds:d,scaleOrigin:n,scaleAxisRotation:h,initialPageTransform:o,initialShape:s});let l=this.getShapeUtil(s);if(l.isAspectRatioLocked(s)&&(t=Math.abs(t.x)>Math.abs(t.y)?new r.GF(t.x,Math.sign(t.y)*Math.abs(t.x)):new r.GF(Math.sign(t.x)*Math.abs(t.y),t.y)),l.onResize&&l.canResize(s)){let p=this._scalePagePoint(r.yX.applyToPoint(o,new r.GF(0,0)),n,t,h),u=this.getPointInParentSpace(s.id,p),g=new r.GF(t.x,t.y),c=(0,r.C2)((a-h)%Math.PI,0);g.x=c?t.x:t.y,g.y=c?t.y:t.x;let y=r.yX.applyToPoint(o,new r.GF),{x:m,y:f}=this.getPointInParentSpace(s.id,y);this.updateShapes([{id:e,type:s.type,x:u.x,y:u.y,...l.onResize({...s,x:m,y:f},{newPoint:u,handle:i.dragHandle??"bottom_right",mode:i.mode??"scale_shape",scaleX:g.x,scaleY:g.y,initialBounds:d,initialShape:s})}],!0)}else{let i=r.yX.applyToPoint(o,d.center),a=this._scalePagePoint(i,n,t,h),l=this.getPointInParentSpace(s.id,i),p=this.getPointInParentSpace(s.id,a),u=r.GF.Sub(p,l);this.updateShapes([{id:e,type:s.type,x:s.x+u.x,y:s.y+u.y}],!0)}return this}stretchShapes(e,t=this.pageState.selectedIds){if(this.isReadOnly||t.length<2)return this;let i=(0,a.oA)(t.map(e=>this.getShapeById(e))),s=Object.fromEntries(i.map(e=>[e.id,this.getBounds(e)])),n=Object.fromEntries(i.map(e=>[e.id,this.getPageBounds(e)])),h=r.No.Common((0,a.oA)(Object.values(n)));switch(e){case"vertical":this.batch(()=>{for(let e of i){let t=this.getPageRotation(e);if(t%r.yo)continue;let i=s[e.id],a=n[e.id],o=this.getDeltaInParentSpace(e,new r.GF(0,h.minY-a.minY)),{x:d,y:l}=r.GF.Add(o,e);this.updateShapes([{id:e.id,type:e.type,x:d,y:l}],!0);let p=new r.GF(1,h.height/a.height);this.resizeShape(e.id,p,{initialBounds:i,scaleOrigin:new r.GF(a.center.x,h.minY),scaleAxisRotation:0})}});break;case"horizontal":this.batch(()=>{for(let e of i){let t=s[e.id],i=n[e.id],a=this.getPageRotation(e);if(a%r.yo)continue;let o=this.getDeltaInParentSpace(e,new r.GF(h.minX-i.minX,0)),{x:d,y:l}=r.GF.Add(o,e);this.updateShapes([{id:e.id,type:e.type,x:d,y:l}],!0);let p=new r.GF(h.width/i.width,1);this.resizeShape(e.id,p,{initialBounds:t,scaleOrigin:new r.GF(h.minX,i.center.y),scaleAxisRotation:0})}})}return this.updateShapes([]),this}get shapesArray(){return Array.from(this.currentPageShapeIds,e=>this.store.get(e))}get sortedShapesArray(){let e=new Set(this.shapesArray.sort(s.hl)),t=[];return e.forEach(i=>{let s=this.getShapeById(i.parentId);(0,n.VV)(s)||function i(s){t.push(s),e.delete(s),e.forEach(e=>{e.parentId===s.id&&i(e)})}(i)}),t}get selectedShapes(){let{selectedIds:e}=this.pageState;return(0,a.oA)(e.map(e=>this.store.get(e)))}get onlySelectedShape(){let{selectedShapes:e}=this;return 1===e.length?e[0]:null}isShapeOfType(e,t){return e.type===t.type}getShapeById(e){if((0,n.YT)(e))return this.store.get(e)}getParentShape(e){if(void 0!==e&&(0,n.YT)(e.parentId))return this.store.get(e.parentId)}getShapeNearestSibling(e,t){if(!t)return;if(t.parentId===e.parentId)return t;let i=this.findAncestor(t,t=>t.parentId===e.parentId);return i}isShapeInPage(e,t=this.currentPageId){let i=!1;if(e.parentId===t)i=!0;else{let s=this.getShapeById(e.parentId);for(;s;){if(s.parentId===t){i=!0;break}s=this.getShapeById(s.parentId)}}return i}getAncestorPageId(e){if(void 0!==e)return(0,n.r5)(e.parentId)?e.parentId:this.getAncestorPageId(this.getShapeById(e.parentId))}_parentIdsToChildIds;reparentShapesById(e,t,i){let h;let o=[],d=(0,n.r5)(t)?r.yX.Identity():this.getPageTransformById(t),l=d.decompose().rotation,p=[],u=(0,a.oA)(this.getSortedChildIds(t).map(e=>this.getShapeById(e)));if(i){let t=u.find(e=>e.index===i);if(t){let r=u[u.indexOf(t)+1];p=r?(0,s.Xv)(i,r.index,e.length):(0,s.vw)(i,e.length)}else{let t=u.sort(s.hl).find(e=>e.index>i);p=t?(0,s.Xv)(i,t.index,e.length):(0,s.vw)(i,e.length)}}else{let t=u.length&&u[u.length-1];p=t?(0,s.vw)(t.index,e.length):(0,s.H$)(e.length)}for(let i=0;i<e.length;i++){h=e[i];let s=this.getShapeById(h),n=this.getPagePointById(h);if(!s||!n)continue;let a=r.yX.applyToPoint(r.yX.Inverse(d),n),u=this.getPageRotation(s)-l;o.push({id:s.id,type:s.type,parentId:t,x:a.x,y:a.y,rotation:u,index:p[i]})}return this.updateShapes(o),this}getHighestIndexForParent(e){let t=this._parentIdsToChildIds.value[e];return t&&0!==t.length?(0,s._L)(t[t.length-1][1]):"a1"}_childIdsCache=new y._;getSortedChildIds(e){let t=this._parentIdsToChildIds.value[e];return t?this._childIdsCache.get(t,()=>t.map(([e])=>e)):d.LZ}visitDescendants(e,t){let i=this.getSortedChildIds(e);for(let e of i)!1!==t(e)&&this.visitDescendants(e,t)}getShapeAndDescendantIds(e){let t=new Set,i=[...e];for(;i.length>0;){let e=i.pop();if(!e)break;t.has(e)||(t.add(e),this.getSortedChildIds(e).forEach(e=>{i.push(e)}))}return t}getParentIdForNewShapeAtPoint(e,t){let i=this.sortedShapesArray;for(let s=i.length-1;s>=0;s--){let r=i[s],n=this.getShapeUtil(r);if(!n.canReceiveNewChildrenOfType(r,t))continue;let a=this.getMaskedPageBoundsById(r.id);if(a&&a.containsPoint(e)&&n.hitTestPoint(r,this.getPointInShapeSpace(r,e)))return r.id}return this.focusLayerId}getDroppingShape(e,t=[]){let i=this.sortedShapesArray;for(let s=i.length-1;s>=0;s--){let r=i[s];if(t.find(e=>e.id===r.id||this.hasAncestor(r,e.id)))continue;let n=this.getShapeUtil(r);if(!n.canDropShapes(r,t))continue;let a=this.getMaskedPageBoundsById(r.id);if(a&&a.containsPoint(e)&&n.hitTestPoint(r,this.getPointInShapeSpace(r,e)))return r}}getOutermostSelectableShape(e,t){let i=e,s=e;for(;s;){if(this.isShapeOfType(s,z.Q)&&this.focusLayerId!==s.id&&!this.hasAncestor(this.focusLayerShape,s.id)&&(t?.(s)??!0))i=s;else if(this.focusLayerId===s.id)break;s=this.getParentShape(s)}return i}setCurrentPageId(e,{stopFollowing:t=!0}={}){return this._setCurrentPageId(e,{stopFollowing:t}),this}_setCurrentPageId=this.history.createCommand("setCurrentPage",(e,{stopFollowing:t=!0}={})=>{if(!this.store.has(e)){console.error("Tried to set the current page id to a page that doesn't exist.");return}return t&&this.instanceState.followingUserId&&this.stopFollowingUser(),{data:{toId:e,fromId:this.currentPageId},squashing:!0,preservesRedoStack:!0}},{do:({toId:e})=>{if(this.store.has(e)){if(!this.getPageStateByPageId(e)){let t=n.AN.create({id:n.AN.createId(e)});this.store.put([t,n.iS.create({id:n.iS.createId(e),pageId:e})])}this.store.put([{...this.instanceState,currentPageId:e}]),this.updateRenderingBounds()}},undo:({fromId:e})=>{this.store.has(e)&&(this.store.put([{...this.instanceState,currentPageId:e}]),this.updateRenderingBounds())},squash:({fromId:e},{toId:t})=>({toId:t,fromId:e})});updateInstanceState(e,t=!1,i=!1){return this._updateInstanceState(e,t,i),this}_updateInstanceState=this.history.createCommand("updateTabState",(e,t=!1,i=!1)=>{let s=this.instanceState,r={...s,...e};return{data:{prev:s,next:r},squashing:i,ephemeral:t}},{do:({next:e})=>{this.store.put([e])},undo:({prev:e})=>{this.store.put([e])},squash:({prev:e},{next:t})=>({prev:e,next:t})});setCursor(e){let t=this.cursor,i={...t,rotation:0,...e};return t.type===i.type&&t.rotation===i.rotation&&t.color===i.color||this.updateInstanceState({cursor:i},!0),this}setScribble(e=null){return this.updateInstanceState({scribble:e},!0),this}setBrush(e=null){return(e||this.brush)&&this.updateInstanceState({brush:e},!0),this}setZoomBrush(e=null){return(e||this.zoomBrush)&&this.updateInstanceState({zoomBrush:e},!0),this}rotateShapesBy(e,t){if(e.length<=0)return this;let i=(0,S.o)({editor:this});return(0,S.Z)({delta:t,snapshot:i,editor:this,stage:"one-off"}),this}nudgeShapes(e,t,i=!1,s=!1){if(e.length<=0)return this;let n=this.isGridMode?i?this.gridSize*u.ZI:this.gridSize:i?u.av:u._Y,a=r.GF.Mul(t,n),h=[];for(let t of e){let e=this.getShapeById(t);if(!e)throw Error(`Could not find a shape with the id ${t}.`);let i=this.getDeltaInParentSpace(e,a),s=this.getShapeUtil(e).onTranslateStart?.(e);h.push(s?{...s,x:e.x+i.x,y:e.y+i.y}:{id:t,x:e.x+i.x,y:e.y+i.y,type:e.type})}return this.updateShapes(h,s),this}duplicateShapes(e=this.selectedIds,t){if(e.length<=0)return this;let i=new Set(e),h=[],o=[...e];for(;o.length>0;){let e=o.pop();if(!e)break;h.push(e),this.getSortedChildIds(e).forEach(e=>o.push(e))}h.reverse();let d=new Map(h.map(e=>[e,(0,n.F1)()])),l=(0,a.oA)(h.map(e=>{let n=this.getShapeById(e);if(!n)return null;let h=d.get(e),o=0,l=0;if(t&&i.has(e)){let e=this.getParentTransform(n),i=new r.GF(t.x,t.y).rot(-r.yX.Decompose(e).rotation);o=i.x,l=i.y}let p=n.parentId??this.currentPageId,u=this.getSortedChildIds(p),g=u.indexOf(n.id),c=u[g+1],y=c?this.getShapeById(c):null,m=y?(0,s.eI)(n.index,y.index):(0,s._L)(n.index),f=(0,a.p$)(n);if(this.isShapeOfType(n,k.Y)&&this.isShapeOfType(f,k.Y)){let e,t;let i=this.getShapeUtil(k.Y).getArrowInfo(n);if("binding"===n.props.start.type&&!(e=d.get(n.props.start.boundShapeId))){if(i?.isValid){let{x:e,y:t}=i.start.point;f.props.start={type:"point",x:e,y:t}}else{let{start:e}=(0,O.Qs)(this,n);f.props.start={type:"point",x:e.x,y:e.y}}}if("binding"===n.props.end.type&&!(t=d.get(n.props.end.boundShapeId))){if(i?.isValid){let{x:e,y:t}=i.end.point;f.props.end={type:"point",x:e,y:t}}else{let{end:e}=(0,O.Qs)(this,n);f.props.start={type:"point",x:e.x,y:e.y}}}let s=(0,O.el)(f)?(0,R.rc)(this,f):(0,E.pe)(this,f);if(i?.isValid&&s?.isValid&&!(0,O.el)(n)){let e=r.GF.Med(i.start.handle,i.end.handle),t=r.GF.Dist(i.middle,e),n=r.GF.Dist(s.middle,e);f.props.bend<0?f.props.bend+=n-t:f.props.bend-=n-t}"binding"===f.props.start.type&&e&&(f.props.start.boundShapeId=e),"binding"===f.props.end.type&&t&&(f.props.end.boundShapeId=t)}return{...f,id:h,x:n.x+o,y:n.y+l,index:m}}));return l.forEach(e=>{(0,n.YT)(e.parentId)&&d.has(e.parentId)&&(e.parentId=d.get(e.parentId))}),this.history.batch(()=>{let e=l.length+this.currentPageShapeIds.size>u.kx;e&&Y(this);let i=e?l.slice(0,u.kx-this.currentPageShapeIds.size):l,s=i.map(e=>e.id);if(this.createShapes(i),this.setSelectedIds(s),void 0!==t){let{viewportPageBounds:e,selectedPageBounds:t}=this;t&&!e.contains(t)&&this.centerOnPoint(t.center.x,t.center.y,{duration:u.KD})}}),this}setOpacity(e,t=!1,i=!1){return this.history.batch(()=>{if(this.isIn("select")){let{pageState:{selectedIds:i}}=this,s=[],r=e=>{let t=this.getShapeById(e);if(t){if(this.isShapeOfType(t,z.Q)){let t=this.getSortedChildIds(e);for(let e of t)r(e)}else s.push(t)}};if(i.length>0){for(let e of i)r(e);this.updateShapes(s.map(t=>({id:t.id,type:t.type,opacity:e})),t)}}this.updateInstanceState({opacityForNextShape:e},t,i)}),this}setStyle(e,t,i=!1,s=!1){return this.history.batch(()=>{if(this.isIn("select")){let{pageState:{selectedIds:s}}=this;if(s.length>0){let r=[],n=i=>{let s=this.getShapeById(i);if(s){if(this.isShapeOfType(s,z.Q)){let e=this.getSortedChildIds(i);for(let t of e)n(t)}else{let i=this.getShapeUtil(s);if(i.hasStyle(e)){let n={id:s.id,type:s.type,props:{}};r.push({originalShape:s,updatePartial:i.setStyleInPartial(e,n,t)})}}}};for(let e of s)n(e);this.updateShapes(r.map(({updatePartial:e})=>e),i);let a=[];for(let{originalShape:e}of r){let t=this.getShapeById(e.id);if(!t)continue;let i=this.getShapeUtil(t),s=i.bounds(e),r=i.bounds(t),n={id:e.id,type:e.type},h=!1;if(s.width!==r.width){if(h=!0,this.isShapeOfType(e,U.z))switch(e.props.align){case"middle":n.x=t.x+(s.width-r.width)/2;break;case"end":n.x=t.x+s.width-r.width}else n.x=t.x+(s.width-r.width)/2}s.height!==r.height&&(h=!0,n.y=t.y+(s.height-r.height)/2),h&&a.push(n)}a.length&&this.updateShapes(a,i)}}this.updateInstanceState({stylesForNextShape:{...this._stylesForNextShape,[e.id]:t}},i,s)}),this}_willSetInitialBounds=!0;_setCamera(e,t,i=this.camera.z){let s=this.camera;if(s.x===e&&s.y===t&&s.z===i)return this;let r={...s,x:e,y:t,z:i};return this.batch(()=>{this.store.put([r]);let{currentScreenPoint:e}=this.inputs;this.dispatch({type:"pointer",target:"canvas",name:"pointer_move",point:e,pointerId:u.CK.CAMERA_MOVE,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,shiftKey:this.inputs.shiftKey,button:0,isPen:this.isPenMode??!1}),this._tickCameraState()}),this}setCamera(e,t,i=this.camera.z,{stopFollowing:s=!0}={}){return this.stopCameraAnimation(),s&&this.instanceState.followingUserId&&this.stopFollowingUser(),e=Number.isNaN(e)?0:e,t=Number.isNaN(t)?0:t,i=Number.isNaN(i)?1:i,this._setCamera(e,t,i),this}animateCamera(e,t,i=this.camera.z,s=u.Xy){e=Number.isNaN(e)?0:e,t=Number.isNaN(t)?0:t,i=Number.isNaN(i)?1:i;let{width:n,height:a}=this.viewportScreenBounds,h=n/i,o=a/i,d=new r.No(-e,-t,h,o);return this._animateToViewport(d,s)}centerOnPoint(e,t,i){if(!this.canMoveCamera)return this;let{viewportPageBounds:{width:s,height:r},camera:n}=this;return i?.duration?this.animateCamera(-(e-s/2),-(t-r/2),n.z,i):this.setCamera(-(e-s/2),-(t-r/2),n.z),this}zoomToContent(){let e=this.selectedPageBounds??this.allShapesCommonBounds;return e&&this.zoomToBounds(e.minX,e.minY,e.width,e.height,Math.min(1,this.zoomLevel),{duration:220}),this}zoomToFit(e){if(!this.canMoveCamera)return this;let t=[...this.currentPageShapeIds];if(t.length<=0)return this;let i=r.No.Common((0,a.oA)(t.map(e=>this.getPageBoundsById(e))));return this.zoomToBounds(i.minX,i.minY,i.width,i.height,void 0,e),this}resetZoom(e=this.viewportScreenCenter,t){if(!this.canMoveCamera)return this;let{x:i,y:s,z:r}=this.camera,{x:n,y:a}=e;return t?.duration?this.animateCamera(i+(n/1-n)-(n/r-n),s+(a/1-a)-(a/r-a),1,t):this.setCamera(i+(n/1-n)-(n/r-n),s+(a/1-a)-(a/r-a),1),this}zoomIn(e=this.viewportScreenCenter,t){if(!this.canMoveCamera)return this;let{x:i,y:s,z:r}=this.camera,n=u.sZ;for(let e=1;e<u.E.length;e++){let t=u.E[e-1],i=u.E[e];if(!(i-r<=(i-t)/2)){n=i;break}}let{x:a,y:h}=e;return t?.duration?this.animateCamera(i+(a/n-a)-(a/r-a),s+(h/n-h)-(h/r-h),n,t):this.setCamera(i+(a/n-a)-(a/r-a),s+(h/n-h)-(h/r-h),n),this}zoomOut(e=this.viewportScreenCenter,t){if(!this.canMoveCamera)return this;let{x:i,y:s,z:r}=this.camera,n=u.Zj;for(let e=u.E.length-1;e>0;e--){let t=u.E[e-1],i=u.E[e];if(!(i-r>=(i-t)/2)){n=t;break}}let{x:a,y:h}=e;return t?.duration?this.animateCamera(i+(a/n-a)-(a/r-a),s+(h/n-h)-(h/r-h),n,t):this.setCamera(i+(a/n-a)-(a/r-a),s+(h/n-h)-(h/r-h),n),this}zoomToSelection(e){if(!this.canMoveCamera)return this;let t=this.selectedIds;if(t.length<=0)return this;let i=r.No.Common((0,a.oA)(t.map(e=>this.getPageBoundsById(e))));return this.zoomToBounds(i.minX,i.minY,i.width,i.height,Math.max(1,this.camera.z),e),this}panZoomIntoView(e,t){if(!this.canMoveCamera||e.length<=0)return this;let i=r.No.Common((0,a.oA)(e.map(e=>this.getPageBoundsById(e)))),{viewportPageBounds:s}=this;if(s.h<i.h||s.w<i.w)this.zoomToBounds(i.minX,i.minY,i.width,i.height,this.camera.z,t);else{let e=this._activeAreaManager.offsets.value,r=s.y+e.top,n=s.maxY-e.right,a=s.maxY-e.bottom,h=s.x+e.left,o=i.y,d=i.maxX,l=i.maxY,p=i.x,u=0,g=0;a<l?g=a-l:r>o&&(g=r-o),n<d?u=n-d:h>p&&(u=h-p);let{camera:c}=this;t?.duration?this.animateCamera(c.x+u,c.y+g,c.z,t):this.setCamera(c.x+u,c.y+g,c.z)}return this}zoomToBounds(e,t,i,s,n,a){if(!this.canMoveCamera)return this;let{viewportScreenBounds:h}=this,o=Math.min(256,.28*h.width),d=(0,r.uZ)(Math.min((h.width-o)/i,(h.height-o)/s),u.Zj,u.sZ);return void 0!==n&&(d=Math.min(n,d)),a?.duration?this.animateCamera(-e+(h.width-i*d)/2/d,-t+(h.height-s*d)/2/d,d,a):this.setCamera(-e+(h.width-i*d)/2/d,-t+(h.height-s*d)/2/d,d),this}pan(e,t,i){if(!this.canMoveCamera)return this;let{camera:s}=this,{x:n,y:a,z:h}=s,o=new r.GF(e,t).div(h);return i?.duration?this.animateCamera(n+o.x,a+o.y,h,i):(this.setCamera(n+o.x,a+o.y,h),this)}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_viewportAnimation=null;_animateViewport(e){if(!this._viewportAnimation)return;let t=()=>{this.removeListener("tick",this._animateViewport),this.removeListener("stop-camera-animation",t),this._viewportAnimation=null};this.once("stop-camera-animation",t),this._viewportAnimation.elapsed+=e;let{elapsed:i,easing:s,duration:n,start:a,end:h}=this._viewportAnimation;if(i>n){let e=this.viewportScreenBounds.width/h.width,i=-h.x,s=-h.y;this._setCamera(i,s,e),t();return}let o=n-i,d=s(1-o/n),l=a.minX+(h.minX-a.minX)*d,p=a.minY+(h.minY-a.minY)*d,u=a.maxX+(h.maxX-a.maxX)*d,g=a.maxY+(h.maxY-a.maxY)*d,c=new r.No(l,p,u-l,g-p),y=this.viewportScreenBounds.width/c.width,m=-c.x,f=-c.y;this._setCamera(m,f,y)}_animateToViewport(e,t={}){let{duration:i=0,easing:s=r.Lj.easeInOutCubic}=t,{animationSpeed:n,viewportPageBounds:a}=this;return(this.stopCameraAnimation(),this.instanceState.followingUserId&&this.stopFollowingUser(),0===i||0===n)?this._setCamera(-e.x,-e.y,this.viewportScreenBounds.width/e.width):(this._viewportAnimation={elapsed:0,duration:i/n,easing:s,start:a.clone(),end:e},this.addListener("tick",this._animateViewport),this)}slideCamera(e={}){if(!this.canMoveCamera)return this;this.stopCameraAnimation();let{animationSpeed:t}=this;if(0===t)return;let{speed:i,friction:s,direction:r,speedThreshold:n=.01}=e,a=Math.min(i,1),h=()=>{this.removeListener("tick",o),this.removeListener("stop-camera-animation",h)};this.once("stop-camera-animation",h);let o=e=>{let{x:t,y:i,z:o}=this.camera,d=r.clone().mul(a*e/o);(a*=1-s)<n?h():this._setCamera(t+d.x,i+d.y,o)};return this.addListener("tick",o),this}animateToUser(e){let t=this.store.query.records("instance_presence",()=>({userId:{eq:e}})),i=[...t.value].sort((e,t)=>e.lastActivityTimestamp-t.lastActivityTimestamp).pop();i&&this.batch(()=>{null!==this.instanceState.followingUserId&&this.stopFollowingUser();let t=i.currentPageId===this.currentPageId;t||this.setCurrentPageId(i.currentPageId);let s=i.cursor;this.centerOnPoint(s.x,s.y,t?{duration:500}:void 0);let{highlightedUserIds:r}=this.instanceState;this.updateInstanceState({highlightedUserIds:[...r,e]}),setTimeout(()=>{let t=[...this.instanceState.highlightedUserIds],i=t.indexOf(e);i<0||(t.splice(i,1),this.updateInstanceState({highlightedUserIds:t}))},u.xG)})}startFollowingUser(e){let t=this.store.query.records("instance_presence",()=>({userId:{eq:e}})),i=this.user.id;if(i||console.warn("You should set the userId for the current instance before following a user"),t.value.some(e=>e.followingUserId===i))return;(0,d.ay)(()=>{this.stopFollowingUser(),this.updateInstanceState({followingUserId:e},!0)});let s=()=>{this.removeListener("frame",a),this.removeListener("stop-following",s)},n=!1,a=()=>{let e=[...t.value].sort((e,t)=>e.lastActivityTimestamp-t.lastActivityTimestamp).pop();if(!e){this.stopFollowingUser();return}let s=e.currentPageId===this.currentPageId,a=s?u.CN:1;s||this.setCurrentPageId(e.currentPageId,{stopFollowing:!1});let{center:h,width:o,height:d}=this.viewportPageBounds,l=r.No.From(e.screenBounds),p=l.width/e.camera.z,g=l.height/e.camera.z,c=new r.GF(p/2-e.camera.x,g/2-e.camera.y),y=e.followingUserId===i,m=o+(p-o)*a,f=d+(g-d)*a,S=(0,r.uZ)(this.camera.z*(y?d/f:Math.min(o/m,d/f)),u.Zj,u.sZ),I=this.viewportScreenBounds.w/S,P=this.viewportScreenBounds.h/S,w=c.sub(h),_=r.GF.Add(h,r.GF.Mul(w,a)),v=r.GF.Sub(_,h).len(),x=Math.abs(S-this.camera.z);if(v<u.wi&&x<u.Ns){n=!0;return}n&&v<u.Qd&&x<u.RH||(n=!1,this.stopCameraAnimation(),this.setCamera(-(_.x-I/2),-(_.y-P/2),S,{stopFollowing:!1}))};return this.once("stop-following",s),this.addListener("frame",a),this}stopFollowingUser(){return this.updateInstanceState({followingUserId:null},!0),this.emit("stop-following"),this}animateToShape(e,t=u.Xy){if(!this.canMoveCamera)return this;let i=(0,_.Vt)(this),s=i.width/i.height,r=this.getPageBoundsById(e);if(!r)return this;let n=r.width/r.height,a=r.clone(),h=r.width/i.width;return a.width+=(i.left+i.right)*h,a.height+=(i.top+i.bottom)*h,a.x-=i.left*h,a.y-=i.top*h,n>s?(a.height=r.width/s,a.y-=(a.height-r.height)/2):(a.width=r.height*s,a.x-=(a.width-r.width)/2),this._animateToViewport(a,t)}blur(){return this.complete(),this.getContainer().blur(),this._isFocused.set(!1),this}focus(){return this.getContainer().focus(),this._isFocused.set(!0),this}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}async putExternalContent(e){this.externalContentManager.handleContent(e)}textMeasure;groupShapes(e=this.selectedIds,t=(0,n.F1)()){if(this.isReadOnly||e.length<=1)return this;let i=(0,a.oA)(this._getUnlockedShapeIds(e).map(e=>this.getShapeById(e))),h=i.sort(s.hl).map(e=>e.id),o=r.No.Common((0,a.oA)(i.map(e=>this.getPageBounds(e)))),{x:d,y:l}=o.point,p=this.findCommonAncestor(i)??this.currentPageId;if("select"!==this.currentToolId)return this;this.isIn("select.idle")||this.cancel();let u=i.filter(e=>e.parentId===p).sort(s.hl),g=u[u.length-1]?.index;return this.batch(()=>{this.createShapes([{id:t,type:"group",parentId:p,index:g,x:d,y:l,opacity:1,props:{}}]),this.reparentShapesById(h,t),this.select(t)}),this}ungroupShapes(e=this.selectedIds){if(this.isReadOnly||0===e.length||"select"!==this.currentToolId)return this;this.isIn("select.idle")||this.cancel();let t=new Set,i=(0,a.oA)(e.map(e=>this.getShapeById(e))),s=[];return i.forEach(e=>{this.isShapeOfType(e,z.Q)?s.push(e):t.add(e.id)}),0===s.length||this.batch(()=>{let e;for(let i=0,r=s.length;i<r;i++){e=s[i];let r=this.getSortedChildIds(e.id);for(let e=0,i=r.length;e<i;e++)t.add(r[e]);this.reparentShapesById(r,e.parentId,e.index)}this.deleteShapes(s.map(e=>e.id)),this.select(...t)}),this}async getSvg(e=this.selectedIds.length?this.selectedIds:Object.keys(this.currentPageShapeIds),t={}){if(0===e.length)return;if(!window.document)throw Error("No document");let{scale:i=1,background:s=!1,padding:r=u.s_,darkMode:h=this.isDarkMode,preserveAspectRatio:d=!1}=t,l=this.getContainer(),p=getComputedStyle(l),c=document.createElement("div");c.className=`tl-container tl-theme__${h?"dark":"light"} tl-theme__force-sRGB`,document.body.appendChild(c);let y=getComputedStyle(c),m=new Map,f={fill:(0,a.Ls)(n.R_.values.map(e=>[e,y.getPropertyValue(`--palette-${e}`)])),pattern:(0,a.Ls)(n.R_.values.map(e=>[e,y.getPropertyValue(`--palette-${e}-pattern`)])),semi:(0,a.Ls)(n.R_.values.map(e=>[e,y.getPropertyValue(`--palette-${e}-semi`)])),highlight:(0,a.Ls)(n.R_.values.map(e=>[e,y.getPropertyValue(`--palette-${e}-highlight`)])),text:y.getPropertyValue("--color-text"),background:y.getPropertyValue("--color-background"),solid:y.getPropertyValue("--palette-solid")};document.body.removeChild(c);let S=this.getShapeAndDescendantIds(e),I=this.computeUnorderedRenderingShapes([this.currentPageId]).filter(({id:e})=>S.has(e)),P=null;for(let{maskedPageBounds:e}of I)e&&(P?P.union(e):P=e.clone());if(!P)return;let w=1===e.length&&this.isShapeOfType(this.getShapeById(e[0]),N.U)?e[0]:null;w||P.expandBy(r);let _=P.width*i,v=P.height*i,x=window.document.createElementNS("http://www.w3.org/2000/svg","svg");d&&x.setAttribute("preserveAspectRatio",d),x.setAttribute("direction","ltr"),x.setAttribute("width",_+""),x.setAttribute("height",v+""),x.setAttribute("viewBox",`${P.minX} ${P.minY} ${P.width} ${P.height}`),x.setAttribute("stroke-linecap","round"),x.setAttribute("stroke-linejoin","round"),s?w?x.style.setProperty("background",f.solid):x.style.setProperty("background-color",f.background):x.style.setProperty("background-color","transparent");let C=window.document.createElementNS("http://www.w3.org/2000/svg","defs");for(let e of Array.from((0,g.A)(f.solid)))C.appendChild(e);try{document.body.focus?.()}catch(e){}x.append(C);let B=(await Promise.all(I.map(async({id:e,opacity:t,index:i,backgroundIndex:s})=>{let r;if(e===w)return[];let a=this.getShapeById(e);if(this.isShapeOfType(a,z.Q))return[];let h=this.getShapeUtil(a),d=h.getStyleIfExists(n.Y8,a);d&&(m.has(d)?r=m.get(d):(r=p.getPropertyValue(`--tl-font-${d}`),m.set(d,r)));let l=await h.toSvg?.(a,r,f),u=await h.toBackgroundSvg?.(a,r,f);if(l){let e=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(l),l=e}if(u){let e=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(u),u=e}if(!l&&!u){let e=this.getPageBounds(a),t=window.document.createElementNS("http://www.w3.org/2000/svg","rect");t.setAttribute("width",e.width+""),t.setAttribute("height",e.height+""),t.setAttribute("fill",f.solid),t.setAttribute("stroke",f.pattern.grey),t.setAttribute("stroke-width","1"),l=t}let g=this.getPageTransform(a).toCssString();"scale"in a.props&&1!==a.props.scale&&(g=`${g} scale(${a.props.scale}, ${a.props.scale})`),l?.setAttribute("transform",g),u?.setAttribute("transform",g),l?.setAttribute("opacity",t+""),u?.setAttribute("opacity",t+"");let c=this.getPageMaskById(a.id);if(c){let e=document.createElementNS("http://www.w3.org/2000/svg","clipPath");C.appendChild(e);let t=(0,o.x0)();e.id=t;let i=document.createElementNS("http://www.w3.org/2000/svg","path");if(i.setAttribute("d",`M${c.map(({x:e,y:t})=>`${e},${t}`).join("L")}Z`),e.appendChild(i),l){let e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("clip-path",`url(#${t})`),e.appendChild(l),l=e}if(u){let e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("clip-path",`url(#${t})`),e.appendChild(u),u=e}}let y=[];return l&&y.push({zIndex:i,element:l}),u&&y.push({zIndex:s,element:u}),y}))).flat();for(let{element:e}of B.sort((e,t)=>e.zIndex-t.zIndex))x.appendChild(e);let b="",A=window.document.createElementNS("http://www.w3.org/2000/svg","style"),T=[];return"fonts"in document&&document.fonts.forEach(e=>T.push(e)),await Promise.all(T.map(async e=>{let t=new FileReader,i=!1;if(m.forEach(t=>{t.includes(e.family)&&(i=!0)}),!i)return;let s=e.$$_url,r=e.$$_fontface;if(s){let e=await (await fetch(s)).blob(),i=await new Promise((i,s)=>{t.onload=()=>i(t.result),t.onerror=()=>s(t.error),t.readAsDataURL(e)}),n="\n"+r.replaceAll(s,i);b+=n}})),A.textContent=b,C.append(A),x}}function Y(e,t=e.currentPageId){let i=e.getPageById(t).name;e.emit("max-shapes",{name:i,pageId:t,count:u.kx})}G([d.Fl],K.prototype,"_pageTransformCache",1),G([d.Fl],K.prototype,"_pageBoundsCache",1),G([d.Fl],K.prototype,"canUndo",1),G([d.Fl],K.prototype,"canRedo",1),G([d.Fl],K.prototype,"_stylesForNextShape",1),G([(0,d.Fl)({isEqual:(e,t)=>e.equals(t)})],K.prototype,"sharedStyles",1),G([d.Fl],K.prototype,"sharedOpacity",1),G([d.Fl],K.prototype,"_arrowBindingsIndex",1),G([d.Fl],K.prototype,"_allPageStates",1),G([d.Fl],K.prototype,"openMenus",1),G([d.Fl],K.prototype,"isMenuOpen",1),G([d.Fl],K.prototype,"documentSettings",1),G([d.Fl],K.prototype,"_pages",1),G([d.Fl],K.prototype,"pages",1),G([d.Fl],K.prototype,"_pageStates",1),G([d.Fl],K.prototype,"pageStateId",1),G([d.Fl],K.prototype,"pageState",1),G([d.Fl],K.prototype,"selectedIds",1),G([d.Fl],K.prototype,"selectedIdsSet",1),G([d.Fl],K.prototype,"editingShape",1),G([d.Fl],K.prototype,"hoveredId",1),G([d.Fl],K.prototype,"hoveredShape",1),G([d.Fl],K.prototype,"hintingIds",1),G([d.Fl],K.prototype,"erasingIds",1),G([d.Fl],K.prototype,"erasingIdsSet",1),G([d.Fl],K.prototype,"cameraId",1),G([d.Fl],K.prototype,"camera",1),G([d.Fl],K.prototype,"zoomLevel",1),G([d.Fl],K.prototype,"viewportScreenBounds",1),G([d.Fl],K.prototype,"viewportScreenCenter",1),G([d.Fl],K.prototype,"viewportPageBounds",1),G([d.Fl],K.prototype,"viewportPageCenter",1),G([d.Fl],K.prototype,"cameraState",1),G([d.Fl],K.prototype,"renderingShapes",1),G([d.Fl],K.prototype,"renderingBounds",1),G([d.Fl],K.prototype,"renderingBoundsExpanded",1),G([d.Fl],K.prototype,"_clipPathCache",1),G([d.Fl],K.prototype,"_pageMaskCache",1),G([d.Fl],K.prototype,"allShapesCommonBounds",1),G([d.Fl],K.prototype,"selectedPageBounds",1),G([d.Fl],K.prototype,"selectionRotation",1),G([d.Fl],K.prototype,"selectionBounds",1),G([d.Fl],K.prototype,"selectionPageCenter",1),G([d.Fl],K.prototype,"_assets",1),G([d.Fl],K.prototype,"shapesArray",1),G([d.Fl],K.prototype,"sortedShapesArray",1),G([d.Fl],K.prototype,"selectedShapes",1),G([d.Fl],K.prototype,"onlySelectedShape",1)}}]);